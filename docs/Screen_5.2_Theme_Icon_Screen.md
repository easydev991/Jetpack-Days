# Экран 5.2: Theme and Icon Screen (Тема и иконка)

## Обзор

Theme and Icon Screen предназначен для настройки темы приложения и выбора иконки приложения. Экран позволяет пользователю выбрать между светлой, темной и системной темой, а также выбрать одну из доступных иконок приложения.

## Назначение

Настройка темы приложения и выбор иконки приложения с сохранением настроек в DataStore.

## Компоненты

1. **Заголовок экрана** — "Тема и иконка"
2. **Секция "Тема приложения"**
   - Заголовок: "Тема"
   - Выбор из опций:
     - "Светлая"
     - "Тёмная"
     - "Системная"
   - Радиокнопки или Dropdown
3. **Секция "Иконка приложения"**
   - Заголовок: "Иконка"
   - Сетка с иконками (GridView)
   - Каждая иконка:
     - Превью иконки (65x65dp)
     - Галочка на выбранной иконке
   - При клике — установка иконки (если поддерживается системой)

## Навигация

- Кнопка "Назад" → Screen 5.1 (More Screen)

## Зависимости от других этапов

- ⚠️ **Требуется Экран 5.1**: More Screen — находится в разработке (есть заглушка в RootScreenComponents.kt), требуется полная реализация для навигации к ThemeIcon Screen
- ✅ **DataStore**: Зависимость уже добавлена в build.gradle.kts (androidx.datastore.preferences)

---

## Общий статус этапа

**Статус:** ❌ НЕ НАЧАТ

**Прогресс реализации:**
- Шаг 1: Структура и навигация — ❌ 0% (0 из 4 задач)
- Шаг 2: DataStore и хранение настроек — ❌ 0% (0 из 6 задач)
- Шаг 3: ViewModel — ❌ 0% (0 из 7 задач)
- Шаг 4: Обновление темы приложения — ⚠️ 40% (2 из 5 задач)
- Шаг 5: UI компоненты - Секция темы — ❌ 0% (0 из 5 задач)
- Шаг 6: UI компоненты - Секция иконки — ⚠️ 20% (1 из 7 задач)
- Шаг 7: Функциональность изменения иконки — ❌ 0% (0 из 5 задач)
- Шаг 8: Верстка компонентов — ❌ 0% (0 из 6 задач)
- Шаг 9: Локализация — ✅ 100% (1 из 2 задач)

**Общий прогресс:** ≈ 8% (3 из 47 задач выполнены)

---

## Рекомендуемый порядок реализации (TDD)

С учётом зависимостей и принципов TDD, рекомендуется следующий порядок:

### Фаза 1: Базовая инфраструктура (Unit-тесты первыми)
1. **Шаг 2.1**: Создать AppTheme и AppIcon enums → Написать unit-тесты
2. **Шаг 2.1**: Реализовать AppSettingsDataStore → Написать unit-тесты
3. **Шаг 3.1**: Создать ThemeIconViewModel → Написать unit-тесты

### Фаза 2: Интеграция темы
4. **Шаг 4.1**: Расширить jetpackDaysTheme() для AppTheme → Написать unit-тесты
5. **Шаг 4.1**: Интегрировать тему с MainActivity/RootScreen → Интеграционные тесты

### Фаза 3: Навигация
6. **Шаг 1.1**: Добавить маршрут ThemeIcon в Screen.kt
7. **Шаг 1.1**: Создать ThemeIconScreen.kt с базовой структурой
8. **Шаг 1.1**: Настроить навигацию из More Screen

### Фаза 4: UI реализация
9. **Шаг 5.1**: Реализовать секцию выбора темы → UI тесты
10. **Шаг 6.1**: Подготовить ресурсы превью иконок
11. **Шаг 6.1**: Реализовать сетку иконок → UI тесты
12. **Шаг 8.1**: Финальная верстка экрана

### Фаза 5: Функциональность смены иконки (Android-specific)
13. **Шаг 7.1**: Создать Activity Aliases в AndroidManifest.xml
14. **Шаг 7.1**: Реализовать логику смены иконки через PackageManager → Unit-тесты
15. **Шаг 7.1**: Добавить проверку версии Android для скрытия секции на старых версиях

### Фаза 6: Финальное тестирование
16. **Шаг 10**: Комплексное тестирование всех функций

**Примечание:** Этот порядок учитывает принципы TDD — сначала тесты для бизнес-логики, потом реализация, потом UI тесты.

---

## Подробный план реализации по TDD

### Шаг 1: Структура и навигация

**Статус:** ❌ НЕ НАЧАТ

#### 1.1. Добавление маршрута

**Задачи:**
1. ❌ Добавить маршрут `ThemeIcon` в `navigation/Screen.kt` (текущее состояние: маршрут отсутствует)
2. ❌ Создать отдельный файл `ThemeIconScreen.kt` в `ui/screen/` (текущее состояние: файл отсутствует)
3. ❌ Реализовать навигацию к экрану из Screen 5.1 (More Screen)
4. ❌ Добавить кнопку "Назад" с навигацией к Screen 5.1

**Критерии готовности:**
- ❌ Маршрут добавлен
- ❌ Файл ThemeIconScreen.kt создан
- ❌ Навигация настроена

---

### Шаг 2: DataStore и хранение настроек

**Статус:** ❌ НЕ НАЧАТ

#### 2.1. Создание DataStore

**Текущее состояние:**
- ✅ Зависимость `androidx.datastore.preferences` добавлена в build.gradle.kts (строка 75)
- ❌ Реализация DataStore для настроек отсутствует
- ❌ Модели AppTheme и AppIcon отсутствуют

**Задачи:**
1. ❌ Создать Preferences DataStore для хранения настроек приложения
2. ❌ Создать модель `AppTheme` enum (LIGHT, DARK, SYSTEM)
3. ❌ Создать модель `AppIcon` enum (DEFAULT, ICON_2, ICON_3, ICON_4, ICON_5)
4. ❌ Реализовать сохранение выбранной темы (светлая/тёмная/системная)
5. ❌ Реализовать сохранение выбранной иконки приложения
6. ❌ Написать unit-тесты для DataStore

**Структура:**
```kotlin
// domain/model/AppTheme.kt
enum class AppTheme {
    LIGHT, DARK, SYSTEM
}

// domain/model/AppIcon.kt
enum class AppIcon {
    DEFAULT, ICON_2, ICON_3, ICON_4, ICON_5
}

// data/preferences/AppSettingsDataStore.kt
class AppSettingsDataStore(context: Context) {
    suspend fun setTheme(theme: AppTheme)
    suspend fun setIcon(icon: AppIcon)
    val theme: Flow<AppTheme>
    val icon: Flow<AppIcon>
}
```

**Критерии готовности:**
- ❌ DataStore создан
- ❌ Сохранение настроек работает
- ❌ Unit-тесты написаны и проходят

---

### Шаг 3: ViewModel

**Статус:** ❌ НЕ НАЧАТ

#### 3.1. Создание ViewModel

**Текущее состояние:**
- ❌ ViewModel отсутствует

**Задачи:**
1. ❌ Создать `ThemeIconViewModel` для управления состоянием настроек
2. ❌ Создать UI State для экрана (ThemeIconUiState)
3. ❌ Реализовать загрузку текущих настроек из DataStore
4. ❌ Реализовать обновление темы приложения
5. ❌ Реализовать обновление иконки приложения
6. ❌ Использовать `viewModelScope` для корутин
7. ❌ Написать unit-тесты для ViewModel

**Структура:**
```kotlin
// ui/state/ThemeIconUiState.kt
data class ThemeIconUiState(
    val theme: AppTheme = AppTheme.SYSTEM,
    val icon: AppIcon = AppIcon.DEFAULT,
    val isLoading: Boolean = false
)

// viewmodel/ThemeIconViewModel.kt
class ThemeIconViewModel(
    private val dataStore: AppSettingsDataStore
) : ViewModel() {
    val uiState: StateFlow<ThemeIconUiState>
    fun updateTheme(theme: AppTheme)
    fun updateIcon(icon: AppIcon)
}
```

**Критерии готовности:**
- ❌ ViewModel создан
- ❌ Загрузка настроек работает
- ❌ Обновление настроек работает
- ❌ Unit-тесты написаны и проходят

---

### Шаг 4: Обновление темы приложения

**Статус:** ⚠️ ЧАСТИЧНО ГОТОВ

#### 4.1. Расширение темы

**Текущее состояние:**
- ✅ Функция `jetpackDaysTheme()` существует в `ui/theme/Theme.kt` (строки 34-55)
- ✅ Параметр `darkTheme` поддерживается (строка 35)
- ❌ Параметр принимает только Boolean, не поддерживает AppTheme enum
- ❌ Не используется в MainActivity для применения темы приложения

**Задачи:**
1. ❌ Расширить `jetpackDaysTheme()` для поддержки выбора темы пользователем (добавить параметр `appTheme: AppTheme? = null`)
2. ❌ Обработать значения AppTheme.LIGHT, AppTheme.DARK, AppTheme.SYSTEM
3. ❌ Интегрировать с ThemeIconViewModel для наблюдения за изменениями темы
4. ❌ Обеспечить применение выбранной темы во всём приложении (через MainActivity или RootScreen)
5. ❌ Написать unit-тесты для темы

**Изменения в Theme.kt:**
```kotlin
@Composable
fun jetpackDaysTheme(
    appTheme: AppTheme? = null, // Новый параметр
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit,
) {
    val useDarkTheme = when (appTheme) {
        AppTheme.LIGHT -> false
        AppTheme.DARK -> true
        AppTheme.SYSTEM, null -> isSystemInDarkTheme()
    }
    // ... остальной код
}
```

**Критерии готовности:**
- ❌ Тема расширена для AppTheme
- ❌ Переключение темы работает
- ❌ Применение темы работает во всём приложении
- ❌ Unit-тесты написаны и проходят

---

### Шаг 5: UI компоненты - Секция темы

**Статус:** ❌ НЕ НАЧАТ

#### 5.1. Реализация выбора темы

**Текущее состояние:**
- ❌ UI компоненты отсутствуют

**Задачи:**
1. ❌ Создать раздел для выбора темы приложения в ThemeIconScreen
2. ❌ Реализовать Dropdown (ExposedDropdownMenuBox) или RadioButtons для выбора темы
3. ❌ Отобразить текущую выбранную тему
4. ❌ Связать с ThemeIconViewModel для обновления темы
5. ❌ Написать UI тесты для выбора темы

**Компоненты для использования:**
- `ExposedDropdownMenuBox` для выпадающего списка
- `DropdownMenuItem` для опций темы (Light, Dark, System)
- Или `RadioButton` с `Column` для выбора

**Критерии готовности:**
- ❌ Раздел темы создан
- ❌ Выбор темы работает
- ❌ Текущая тема отображается
- ❌ UI тесты написаны

---

### Шаг 6: UI компоненты - Секция иконки

**Статус:** ⚠️ ЧАСТИЧНО ГОТОВ (ресурсы)

#### 6.1. Реализация выбора иконки

**Текущее состояние:**
- ✅ Строковые ресурсы локализованы (`app_icon`, `primary_icon`, `variant` в strings.xml)
- ✅ Строковые ресурсы для ru и en языков добавлены
- ⚠️ Иконки запуска: существуют `ic_launcher_foreground.xml`, `ic_launcher_background.xml` и mipmaps
- ❌ Отсутствуют ресурсы для превью иконок (65x65dp)
- ❌ UI компоненты отсутствуют

**Задачи:**
1. ❌ Создать сетку для отображения доступных иконок (LazyVerticalGrid) в ThemeIconScreen
2. ❌ Добавить ресурсы превью иконок (65x65dp, drawable)
3. ❌ Реализовать превью иконок с обводкой
4. ❌ Реализовать визуальное выделение выбранной иконки (галочка)
5. ❌ Добавить обработчик клика для выбора иконки
6. ❌ Связать с ThemeIconViewModel для обновления иконки
7. ❌ Написать UI тесты для выбора иконки

**Компоненты для использования:**
- `LazyVerticalGrid` с `GridItem.Adaptive(minimum = 65.dp)`
- `Box` для компоновки иконки с галочкой
- `Image` для превью иконки
- `Icon` с `Icons.Filled.Check` для галочки

**Критерии готовности:**
- ❌ Сетка иконок создана
- ❌ Превью иконок работает
- ❌ Выделение выбранной иконки работает
- ❌ UI тесты написаны

---

### Шаг 7: Функциональность изменения иконки

**Статус:** ❌ НЕ НАЧАТ

#### 7.1. Реализация изменения иконки

**Текущее состояние:**
- ❌ Функциональность изменения иконки не реализована

**Примечание по Android:**
Изменение иконки приложения на Android работает иначе, чем на iOS:
- iOS: `UIApplication.shared.setAlternateIconName()`
- Android: Activity Aliases в AndroidManifest.xml + PackageManager.setComponentEnabledSetting()
- Поддерживается на Android 8.0 (API 26) и выше

**Задачи:**
1. ❌ Создать Activity Aliases для каждого варианта иконки в AndroidManifest.xml
2. ❌ Реализовать функциональность изменения иконки приложения через PackageManager
3. ❌ Обработать случаи, когда изменение иконки не поддерживается (Android < 8.0)
4. ❌ Добавить проверку версии Android при отображении секции иконок
5. ❌ Написать unit-тесты для изменения иконки

**Структура AndroidManifest.xml:**
```xml
<activity-alias
    android:name=".IconAliasDefault"
    android:enabled="true"
    android:icon="@mipmap/ic_launcher"
    android:targetActivity=".MainActivity">
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
</activity-alias>
<activity-alias
    android:name=".IconAlias2"
    android:enabled="false"
    android:icon="@mipmap/ic_launcher_variant2"
    android:targetActivity=".MainActivity">
    <!-- ... -->
</activity-alias>
```

**Критерии готовности:**
- ❌ Изменение иконки работает (если поддерживается системой)
- ❌ Обработка неподдерживаемых случаев реализована
- ❌ Unit-тесты написаны и проходят

---

### Шаг 8: Верстка компонентов

**Статус:** ❌ НЕ НАЧАТ

#### 8.1. Финальная верстка

**Текущее состояние:**
- ❌ ThemeIconScreen.kt отсутствует
- ❌ Верстка не реализована

**Задачи:**
1. ❌ Использовать вертикальный Column для основного макета ThemeIconScreen
2. ❌ Добавить разделы с заголовками для темы и иконки (использовать SectionTitleView или аналогичный компонент)
3. ❌ Обеспечить адекватное отображение элементов при изменении ориентации экрана
4. ❌ Применить корректные иконки из Material Icons (`Icons.Default.Palette`, `Icons.Default.Face`)
5. ❌ Применить тему приложения с поддержкой темного режима
6. ❌ Добавить кнопку "Назад" в TopAppBar

**Компоненты для использования:**
- `Scaffold` с `TopAppBar` для структуры экрана
- `Column` для вертикальной верстки
- `LazyVerticalGrid` для сетки иконок
- `ExposedDropdownMenuBox` для выбора темы
- `SectionTitleView` (если есть в проекте) или `Text` с MaterialTypography для заголовков

**Критерии готовности:**
- ❌ Верстка выполнена
- ❌ Адаптивность обеспечена
- ❌ Тема применена

---

### Шаг 9: Локализация

**Статус:** ✅ ГОТОВО

#### 9.1. Использование строковых ресурсов

**Текущее состояние:**
- ✅ Все строковые ресурсы уже добавлены и локализованы
- ✅ Ресурсы для английского языка: `app/src/main/res/values/strings.xml` (строки 38, 78-84)
- ✅ Ресурсы для русского языка: `app/src/main/res/values-ru/strings.xml` (строки 38, 78-84)
- ✅ Все необходимые строки присутствуют:
  - `app_theme_and_icon` — заголовок экрана
  - `app_theme` — заголовок секции темы
  - `app_icon` — заголовок секции иконки
  - `light` — опция "Светлая"
  - `dark` — опция "Тёмная"
  - `system` — опция "Системная"
  - `primary_icon` — название основной иконки
  - `variant` — название варианта иконки (с параметром %1$d)

**Задачи:**
1. ✅ Использовать готовые строковые ресурсы из локализованных файлов
2. ❌ Использовать `stringResource()` в ThemeIconScreen для доступа к строкам

**Критерии готовности:**
- ✅ Используются готовые строковые ресурсы
- ❌ Локализация работает корректно в UI (требуется реализация экрана)

**Примечание:** План локализации готов. Все строки определены и локализованы для русского и английского языков. Осталось только использовать их в UI.

---

### Шаг 10: Финальное тестирование

**Статус:** ❌ НЕ НАЧАТ

#### 10.1. Комплексное тестирование

**Текущее состояние:**
- ❌ Финальное тестирование не проводилось

**Задачи:**
1. ❌ Проверить изменение темы приложения (unit + UI тесты)
2. ❌ Проверить сохранение выбранной темы после перезапуска приложения (unit + UI тесты)
3. ❌ Проверить визуальное выделение выбранной иконки (UI тесты)
4. ❌ Проверить корректное отображение сетки иконок (UI тесты)
5. ❌ Проверить выбор иконки и сохранение выбора (UI тесты)
6. ❌ Проверить корректную навигацию назад на More Screen (UI тесты)
7. ❌ Проверить применение темы во всём приложении (интеграционные тесты)
8. ❌ Проверить поведение на Android < 8.0 (отсутствие секции иконок)
9. ❌ Проверить linting (ktlint, detekt) — отсутствие ошибок
10. ❌ Проверить работу приложения на разных ориентациях экрана
11. ❌ Проверить работу на больших экранах (адаптивность)

**Критерии готовности:**
- ❌ Все unit-тесты проходят
- ❌ Все интеграционные тесты проходят
- ❌ Все UI-тесты проходят
- ❌ Линтеры не выдают ошибок (ktlint, detekt)
- ❌ Все функции работают корректно на всех тестируемых сценариях

---

## Реализация (детали)

### UI компоненты
- Использовать вертикальный Column для основного макета
- Добавить разделы с заголовками для темы и иконки
- Добавить радиокнопки или выпадающий список для выбора темы
- Добавить сетку иконок с визуальным выделением выбранной
- Обеспечить адекватное отображение элементов при изменении ориентации экрана
- Использовать современные компоненты Material Design 3
- Применить тему приложения с поддержкой темного режима
- Применить корректные иконки из Material Icons

### Архитектура
- Использовать DataStore для хранения настроек
- Использовать Coroutines для асинхронных операций с DataStore
- Реализовать обработку ошибок и состояний загрузки
- Применить Clean Architecture (Data → Domain → Presentation)

---

## Тестирование

### Unit-тесты

**Текущее состояние:**
- ❌ Тесты для DataStore отсутствуют
- ❌ Тесты для ThemeIconViewModel отсутствуют
- ❌ Тесты для AppTheme enum отсутствуют
- ❌ Тесты для AppIcon enum отсутствуют
- ❌ Тесты для логики изменения иконки отсутствуют

**Необходимые тесты:**
1. ❌ Тесты для AppSettingsDataStore (сохранение и загрузка настроек темы)
2. ❌ Тесты для AppSettingsDataStore (сохранение и загрузка настроек иконки)
3. ❌ Тесты для ThemeIconViewModel (логика управления настройками)
4. ❌ Тесты для ThemeIconViewModel (обновление UI State)
5. ❌ Тесты для утилит изменения иконки (если вынесены отдельно)

### Интеграционные тесты

**Текущее состояние:**
- ❌ Интеграционные тесты отсутствуют

**Необходимые тесты:**
1. ❌ Тесты взаимодействия ThemeIconViewModel с DataStore
2. ❌ Тесты применения темы во всём приложении (интеграция с jetpackDaysTheme)
3. ❌ Тесты изменения иконки через PackageManager (если возможно в тестах)

### UI-тесты

**Текущее состояние:**
- ❌ UI тесты отсутствуют

**Необходимые тесты:**
1. ❌ Проверить отображение экрана ThemeIconScreen
2. ❌ Проверить изменение темы приложения через dropdown/radio buttons
3. ❌ Проверить сохранение выбранной темы (после перезапуска)
4. ❌ Проверить визуальное выделение выбранной иконки (галочка)
5. ❌ Проверить корректное отображение сетки иконок (LazyVerticalGrid)
6. ❌ Проверить выбор иконки (клик по элементу сетки)
7. ❌ Проверить корректную навигацию назад на More Screen

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ✅ Все unit-тесты написаны и проходят
- ✅ Все интеграционные тесты написаны и проходят
- ✅ Все UI-тесты написаны и проходят
- ✅ Код соответствует правилам проекта
- ✅ Линтеры не выдают ошибок
- ✅ Настройки сохраняются корректно
- ✅ Тема применяется корректно во всём приложении

---

## Блокируемые этапы

После завершения этого экрана можно приступать к:
- Нет блокируемых этапов — это финальный экран настроек

---

## Примечания

1. **Изменение иконки на Android**: Изменение иконки приложения на Android работает иначе, чем на iOS:
   - iOS использует `UIApplication.shared.setAlternateIconName()`
   - Android требует создания Activity Aliases в AndroidManifest.xml для каждого варианта иконки
   - Изменение иконки поддерживается только на Android 8.0 (API 26) и выше через `PackageManager.setComponentEnabledSetting()`
   - На более старых версиях Android функция должна быть скрыта или отключена

2. **Системная тема**: При выборе системной темы приложение должно следовать системным настройкам темы устройства (isSystemInDarkTheme()).

3. **Сохранение настроек**: Все настройки должны сохраняться в DataStore (Preferences DataStore) и применяться при следующем запуске приложения.

4. **Тестирование**: Все компоненты должны быть покрыты тестами перед использованием в других этапах (TDD подход).

5. **Зависимости**:
   - ⚠️ Экран 5.1 (More Screen) находится в разработке (есть заглушка в RootScreenComponents.kt)
   - ✅ Зависимость DataStore уже добавлена в build.gradle.kts

---

## Текущее состояние реализации

**На основе анализа кода от января 2026 года:**

### Выполнено

- ✅ Зависимость `androidx.datastore.preferences` добавлена в build.gradle.kts (строка 75)
- ✅ Все строковые ресурсы локализованы для русского и английского языков:
  - `app_theme_and_icon`, `app_theme`, `app_icon` (заголовки)
  - `light`, `dark`, `system` (опции темы)
  - `primary_icon`, `variant` (названия иконок)
- ✅ Базовая структура темы существует в `ui/theme/Theme.kt` с параметром `darkTheme: Boolean`
- ✅ Ресурсы иконок запуска существуют (ic_launcher_foreground.xml, ic_launcher_background.xml)

### Не выполнено

- ❌ Маршрут `ThemeIcon` отсутствует в navigation/Screen.kt
- ❌ Файл `ThemeIconScreen.kt` отсутствует
- ❌ DataStore для хранения настроек не реализован
- ❌ Модели `AppTheme` и `AppIcon` enum отсутствуют
- ❌ `ThemeIconViewModel` отсутствует
- ❌ UI State `ThemeIconUiState` отсутствует
- ❌ Компоненты UI экрана отсутствуют (секция темы, сетка иконок)
- ❌ Функциональность изменения иконки приложения не реализована
- ❌ Тема не интегрирована с ViewModel для наблюдения за изменениями
- ❌ Unit-тесты отсутствуют
- ❌ Интеграционные тесты отсутствуют
- ❌ UI-тесты отсутствуют
- ❌ Навигация от More Screen к ThemeIcon Screen не настроена
- ❌ Activity Aliases для смены иконки в AndroidManifest.xml отсутствуют
- ❌ Ресурсы превью иконок (65x65dp) отсутствуют

### Требует доработки

- ⚠️ Функция `jetpackDaysTheme()` требует расширения для поддержки `AppTheme` enum вместо Boolean
- ⚠️ Интеграция темы с MainActivity или RootScreen для наблюдения за изменениями из DataStore

### Блокирующие зависимости

- ⚠️ **Экран 5.1 (More Screen)**: требует полной реализации для навигации к ThemeIcon Screen
  - Текущее состояние: заглушка в RootScreenComponents.kt с текстом "Экран настроек не реализован"
  - Требуется: кнопка для перехода к ThemeIcon Screen
