# Экран 5.2: Theme and Icon Screen (Тема и иконка)

## Обзор

Theme and Icon Screen предназначен для настройки темы приложения, выбора иконки приложения и настройки динамических цветов. Экран позволяет пользователю выбрать между светлой, темной и системной темой, включить или выключить динамические цвета, а также выбрать одну из доступных иконок приложения.

## Назначение

Настройка темы приложения, динамических цветов и выбор иконки приложения с сохранением настроек в DataStore. Выбранная тема, настройка динамических цветов и иконка должны сохраняться, чтобы при каждом запуске приложения выбор пользователя не сбрасывался.

## Компоненты

1. **Заголовок экрана** — "Тема и иконка"
2. **Секция "Тема приложения"** (выполняется ПЕРЕД секцией иконки)
   - Подзаголовок: "Тема приложения"
   - Три радио-кнопки Material Design (Column с RadioButton):
     - "Светлая" (AppTheme.LIGHT)
     - "Тёмная" (AppTheme.DARK)
     - "Системная" (AppTheme.SYSTEM)
   - При открытии экрана сразу настраивается выбранная тема (из ViewModel, загруженная из DataStore)
   - При нажатии на радио-кнопку с уже выбранной темой ничего не происходит
   - При выборе новой темы — тема применяется через ViewModel и сохраняется в DataStore
   - Выбранная тема сохраняется, чтобы при каждом запуске приложения выбор пользователя не сбрасывался
3. **Секция "Динамические цвета"** (выполняется МЕЖДУ секциями темы и иконки)
   - Подзаголовок секции: "Динамические цвета"
   - Переключатель (Switch) "Использовать динамические цвета"
   - Состояние по умолчанию: `true` (включено)
   - Под переключателем комментарий-подсказка:
     - ru: "При включении этой настройки будут использоваться системные цвета Android 12+ на основе обоев устройства"
     - en: "When this setting is enabled, system colors from Android 12+ based on device wallpaper will be used"
   - При открытии экрана сразу настраивается выбранное состояние (из ViewModel, загруженное из DataStore)
   - При переключении — состояние обновляется через ViewModel и сохраняется в DataStore
   - Выбранное состояние сохраняется, чтобы при каждом запуске приложения выбор пользователя не сбрасывался
   - **Поведение при включении:**
     - На Android 12+ используются системные динамические цвета (`dynamicDarkColorScheme`/`dynamicLightColorScheme`)
     - Кастомные цвета из `Color.kt` игнорируются
     - Цвета автоматически адаптируются под обои устройства
   - **Поведение при выключении:**
     - На всех устройствах используются кастомные цвета из `Color.kt`
     - Включена высокая контрастность цветов (highContrast)
   - Все тексты локализованы (русский и английский языки)
4. **Секция "Иконка приложения"** (выполняется ПОСЛЕ секции динамических цветов)
   - Заголовок секции: "Иконка"
   - Сетка с иконками (FlowRow)
   - Каждая иконка:
     - Превью иконки (64x64dp) — vector drawables из `app/src/main/res/drawable/`
     - Галочка на выбранной иконке
   - При клике — установка иконки (если поддерживается системой)
   - Выбранная иконка сохраняется, чтобы при каждом запуске приложения выбор пользователя не сбрасывался

## Навигация

- Кнопка "Назад" → Screen 5.1 (More Screen)

## Зависимости от других этапов

- ⚠️ **Требуется Экран 5.1**: More Screen — находится в разработке (есть заглушка в RootScreenComponents.kt), требуется полная реализация для навигации к ThemeIcon Screen
- ✅ **DataStore**: Зависимость уже добавлена в build.gradle.kts (androidx.datastore.preferences)
- ✅ **Маршрут**: Маршрут `ThemeIcon` добавлен в navigation/Screen.kt

---

## Общий статус этапа

**Статус:** ✅ ВЫПОЛНЕН ПОЛНОСТЬЮ — UI всех секций работает, все UI-тесты проходят. Поддержка темных версий launcher icons реализована.

**Прогресс реализации:**

- Шаги 0-13: ✅ ВЫПОЛНЕНЫ (78 из 79 задач)

**Отложенные задачи (ручное тестирование):**

- Проверка на разных устройствах (Android 12+, Android < 12, light/dark темы)

---

## Рекомендуемый порядок реализации (TDD)

### Выполнено

- ✅ Фазы 0-7: поддержка темной темы, инфраструктура, навигация, UI, логика смены иконки
- ✅ Шаг 11: секция динамических цветов

### Отложено

- ⏸️ Ручное тестирование на разных устройствах (Android 12+, Android < 12, light/dark темы)

---

## Стандарт Google по реализации темной темы (Material 3)

**Текущее состояние:** ✅ Все требования выполнены — используется `isSystemInDarkTheme()`, динамические цвета через `dynamicDarkColorScheme/lightColorScheme`, автоматическое переключение темы.

---

## Подробный план реализации по TDD

### Выполнено

- ✅ Шаги 0-10: поддержка темной темы, навигация, DataStore, ViewModel, UI секции темы/иконок, верстка, локализация
- ✅ Шаг 11: секция динамических цветов (13/14 задач выполнено)

**Отложено:** ручное тестирование на разных устройствах

---

## Детальный план по итерациям (TDD)

### Выполнено

- ✅ Итерация 1: модели и логика смены иконки (AppIcon enum, IconManager, ThemeIconViewModel, JVM target 17)
- ✅ Итерация 2: конфигурация Activity Aliases (adaptive icons, preview, bitmap, intent-filter LAUNCHER)
- ✅ Итерация 3: UI реализация секции иконок (IconPreviewItem, сетка FlowRow, анимация)

---

## Тестирование

### Выполнено

- ✅ Unit-тесты: AppTheme, AppIcon, IconManager, ThemeIconViewModel (все проходят)
- ✅ UI-тесты: 10/10 для ThemeIconScreenContent (AppBar, секции темы/иконок, клики)

### Отложено (опционально)

- ⏸️ Интеграционные тесты: ThemeIconViewModel с DataStore, применение темы, изменение иконки
- ⏸️ UI-тесты: выбор иконки, отображение галочки

---

## Критерии завершения этапа

✅ Все выполнено — компоненты работают, тесты проходят (unit и UI), настройки сохраняются в DataStore, тема применяется корректно, системная тема переключает приложение.

---

## Блокируемые этапы

- ⚠️ Экран 5.1 (More Screen) — находится в разработке (есть заглушка)

---

## Примечания

1. JVM target обновлен до 17 для совместимости с JUnit 5
2. 6 иконок, мини-версии: vector drawables из `app/src/main/res/drawable/`
3. Смена иконки: Activity Aliases + PackageManager (API 26+)
4. Порядок реализации: секция темы → секция динамических цветов → секция иконок

### Проблема с двойной иконкой — ИСПРАВЛЕНО ✅

Activity Alias для DEFAULT иконки включен по умолчанию, intent-filter LAUNCHER перенесен из MainActivity во все Activity Aliases.

### Запуск через Android Studio после смены иконки — ИСПРАВЛЕНО ✅

1. В `AndroidManifest.xml`: `MainActivity` — `android:exported="true"`
2. В Android Studio: `Run` → `Edit Configurations` → `Launch: Specified Activity` → `Activity: .MainActivity`

**Результат:** нет дублирования иконок, приложение всегда запускается через Android Studio, ручной запуск работает корректно.

---

## Текущее состояние реализации

### Выполнено

✅ DataStore, AppTheme/AppIcon enums, ThemeIconViewModel, навигация, UI всех секций, unit-тесты (JVM target 17), UI-тесты (10/10), adaptive icons (светлые/тёмные), preview/round-версии, Activity Aliases, IconPreviewItem с анимацией, поддержка системной темы/поворота/скролла, локализация, баги исправлены.

### Не выполнено (опционально)

- ❌ Monochrome-версии иконок для Android 13+
- ❌ Интеграционные тесты для смены иконки
- ⏸️ Ручное тестирование на разных устройствах

**Примечание:** все bitmap-версии adaptive icons для разных dpi созданы.

---

## План реализации поддержки темных иконок приложения

### Статус: ✅ ВЫПОЛНЕН ПОЛНОСТЬЮ

**Цель:** автоматическое переключение launcher icon при изменении темы (светлая/тёмная/системная).

### Выполнено

- ✅ Preview иконки (drawable): `icon_preview_X.xml` + dark-версии (X = 2-6), `icon_preview_1.xml` (DEFAULT)
- ✅ Код: `AppIcon.iconResource(isDarkTheme)`, `getComponentName(isDarkTheme)`, `ThemeIconScreen` определяет `isDarkTheme`
- ✅ Adaptive icons (mipmap-anydpi-v26): светлые/тёмные версии + round-версии для всех 6 иконок
- ✅ Bitmap PNG: foreground для всех dpi (mdpi-xxxhdpi), светлые/тёмные версии
- ✅ Цвета фонов: `ic_launcher_X_background.xml` + dark-версии (X = 1-6)
- ✅ IconManager: `changeIcon(icon, isDarkTheme)`, `isDarkThemeForIcon(theme)`
- ✅ ThemeIconViewModel: `updateIcon()` автоматически определяет тему
- ✅ AndroidManifest.xml: 12 Activity Aliases (светлые/тёмные версии), intent-filter LAUNCHER
- ✅ Unit-тесты: покрывают светлую/тёмную/системную темы

### Важные замечания

**Ограничения Android:**

- ❌ `drawable-night/` НЕ работает для launcher icons
- ❌ Автоматическая смена launcher icon при смене системной темы НЕ поддерживается
- ✅ Android 13+ может применять монохромный слой (зависит от launcher)

**Решение:** Activity Aliases для светлых/тёмных версий, программное переключение через IconManager

### Примечания

- DEFAULT иконка: светлая тема (`#FFFFFF`), тёмная тема (`#FFFFFF`)
- Системная тема: иконка preview меняется автоматически через `isSystemInDarkTheme()`
- Activity Aliases: LAUNCHER intent-filter, `MainActivityAliasIcon1` включён по умолчанию
- iOS совместимость: Android требует отдельные ресурсы, iOS использует Asset Catalog

### Исправленные проблемы

- ✅ Android UI-тесты: компилируются, 10/10 тестов для ThemeIconScreen проходят
- ✅ UI реализация: поворот экрана (`Scaffold` + `verticalScroll()`), квадратная иконка в сетке (`FlowRow`), галочка (`AnimatedVisibility`), смена темы (`isDarkTheme`)
