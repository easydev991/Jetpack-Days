# План реализации Этапа 7: Модель данных

## Обзор

Этап 7 является критическим блокером для остальных фич приложения. Реализация модели данных включает создание доменной модели, Room Entity, Database, DAO и необходимых конвертеров. Все компоненты должны быть реализованы с использованием подхода TDD (Test-Driven Development).

## Цель

Создать полноценную модель данных для работы с записями событий (Item), включая:

- Доменную модель (Domain layer)
- Room Entity и конвертеры (Data layer)
- Room Database и DAO (Data layer)
- Unit-тесты для всех компонентов

## Архитектурные принципы

- **Clean Architecture**: Разделение на слои Domain и Data
- **TDD**: Сначала тесты, затем реализация
- **Room**: Использование Room для локального хранения данных
- **Type Safety**: Использование enum для DisplayOption, безопасная работа с опционалами

---

## Шаг 1: Подготовка структуры папок и зависимостей ✅

Создана структура папок для Domain и Data слоев, а также для тестов (unit и androidTest). Зависимости Room и KSP плагин настроены.

---

## Шаг 2: Создание enum DisplayOption (Domain layer) ✅

Создан enum `DisplayOption` в `domain/model/DisplayOption.kt` со значениями DAY, MONTH_DAY, YEAR_MONTH_DAY. Реализованы методы `fromString(value: String)` для парсинга строковых значений (поддержка camelCase формата iOS) и `toJsonString()` для получения строкового представления (camelCase для совместимости с iOS). Значение по умолчанию: DAY. Написаны unit-тесты.

---

## Шаг 3: Создание доменной модели Item (Domain layer) ✅

Создан data class `Item` в `domain/model/Item.kt` со всеми полями: id, title, details, timestamp, colorTag, displayOption. Метод `makeDaysCount(currentDate: Long): String` объявлен с заглушкой (полная реализация в Этапе 6). Написаны unit-тесты.

---

## Шаг 4: Создание Room Entity (Data layer) ✅

Создана Room Entity `ItemEntity` в `data/database/entity/ItemEntity.kt` с правильными аннотациями (`@Entity`, `@PrimaryKey`, `@TypeConverters`). Созданы TypeConverter для `DisplayOption` (конвертация между enum и String) и TypeConverter для `Int?` (colorTag). Обработка null значений корректна. Написаны unit-тесты для конвертеров и Entity.

---

## Шаг 5: Создание маппера между Entity и Domain Model ✅

Созданы extension функции для конвертации в `data/database/mapper/ItemMapper.kt`: `ItemEntity.toDomain()` и `Item.toEntity()`. Конвертация работает в обе стороны, сохраняя все поля. Используется общий экземпляр DisplayOptionConverter для консистентности. Написаны unit-тесты.

---

## Шаг 6: Создание DAO (Data Access Object) ✅

Создан интерфейс `ItemDao` в `data/database/dao/ItemDao.kt` со всеми методами: getAllItems, getItemById, searchItems, insertItem, updateItem, deleteItem, deleteAllItems, getItemsCount. Все методы имеют KDoc комментарии и правильные аннотации Room. Написаны интеграционные тесты с использованием реальной in-memory базы данных.

---

## Шаг 7: Создание Room Database ✅

Создан абстрактный класс `DaysDatabase` в `data/database/DaysDatabase.kt` с правильными аннотациями (`@Database`, `@TypeConverters`). Реализован Singleton паттерн с `@Volatile` и `synchronized` для потокобезопасности. Написаны интеграционные тесты.

---

## Шаг 8: Создание интерфейса Repository (Domain layer) ✅

Создан интерфейс `ItemRepository` в `domain/repository/ItemRepository.kt` со всеми методами: getAllItems, getItemById, searchItems, insertItem, updateItem, deleteItem, deleteAllItems, getItemsCount. Все методы имеют KDoc комментарии. Написаны unit-тесты (проверка контракта).

---

## Шаг 9: Реализация Repository (Data layer) ✅

Создана реализация `ItemRepositoryImpl` в `data/repository/ItemRepositoryImpl.kt`. Реализован интерфейс `ItemRepository` с использованием `ItemDao` для доступа к данным. Конвертация между Entity и Domain моделями через extension-функции маппера. Использование `Flow.map` для реактивной конвертации списков. Написаны unit-тесты с использованием MockK.

---

## Шаг 10: Интеграционное тестирование ✅

Созданы интеграционные тесты в `androidTest/data/repository/ItemRepositoryIntegrationTest.kt`. Тесты покрывают полный цикл CRUD, поиск записей, сортировку, обработку пустой базы данных и конвертацию между Entity и Domain. Все тесты проходят.

---

## Шаг 11: Документация и финализация ✅

Добавлены KDoc комментарии ко всем публичным API (классы, интерфейсы, методы). Проверено соответствие кода правилам проекта: нет использования `!!`, безопасное разворачивание опционалов (`?.`, `?:`), логи на русском языке. Запущены линтеры (ktlint, detekt) — ошибок нет. Исправлены все замечания линтеров (включая использование JUnit 4 вместо JUnit 5 в androidTest).

---

## Порядок выполнения (TDD подход)

**ВАЖНО:** Строго соблюдать порядок TDD

1. **Red**: Написать падающий тест
2. **Green**: Написать минимальный код для прохождения теста
3. **Refactor**: Улучшить код, сохраняя тесты зелеными

### Последовательность реализации

---

1. ✅ Шаг 1: Подготовка структуры папок и зависимостей
2. ✅ Шаг 2: DisplayOption enum + тесты
3. ✅ Шаг 3: Domain Item model + тесты
4. ✅ Шаг 4: Room Entity + конвертеры + тесты
5. ✅ Шаг 5: Мапперы + тесты
6. ✅ Шаг 6: DAO + интеграционные тесты
7. ✅ Шаг 7: Database + тесты
8. ✅ Шаг 8: Repository интерфейс + тесты
9. ✅ Шаг 9: Repository реализация + тесты
10. ✅ Шаг 10: Интеграционные тесты
11. ✅ Шаг 11: Документация и финализация

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ✅ Все unit-тесты написаны и проходят
- ✅ Все интеграционные тесты написаны и проходят
- ✅ Код соответствует правилам проекта
- ✅ Линтеры не выдают ошибок
- ✅ KDoc комментарии добавлены
- ✅ Модель данных готова к использованию в других этапах

### Статус этапа

Статус: ✅ ЭТАП ЗАВЕРШЕН

Все 11 шагов выполнены. Модель данных полностью реализована и готова к использованию в следующих этапах разработки.

---

## Зависимости от других этапов

- **Этап 6 (Форматирование дней)**: Метод `makeDaysCount` в доменной модели Item будет полностью реализован в Этапе 6. На данном этапе создается только заглушка.

---

## Блокируемые этапы

После завершения Этапа 7 можно приступать к

- Этап 2: Главный экран (требует модель данных)
- Этап 3: Детали записи (требует модель данных)
- Этап 4: Создание и редактирование записей (требует модель данных)
- Этап 8: Резервное копирование (требует модель данных)

---

## Примечания

1. **Совместимость с iOS**: Структура модели совместима с iOS-приложением для резервного копирования (Этап 8).
   - **DisplayOption**: Используется camelCase в JSON ("day", "monthDay", "yearMonthDay")
   - **ColorTag**: В iOS хранится как Data (NSKeyedArchiver), в Android используется Base64-строка для JSON
   - **Timestamp**: Используются миллисекунды с 1970-01-01 (как Date в iOS)

2. **Безопасность типов**: Используется enum для DisplayOption вместо строковых констант.

3. **Обработка null**: Все опциональные поля корректно обрабатываются при конвертации между слоями.

4. **Производительность**: Используется Flow для реактивного обновления UI при изменении данных.

5. **Тестирование**: Все компоненты покрыты тестами перед использованием в других этапах.

6. **Формат резервной копии**: При реализации экспорта/импорта (Этап 8) обеспечивается полная совместимость с iOS-форматом.
   - `colorTag` как Base64-строка (сериализованный UIColor через NSKeyedArchiver)
   - `displayOption` в camelCase формате
   - Поддержка обратной совместимости со старыми форматами (если были)
