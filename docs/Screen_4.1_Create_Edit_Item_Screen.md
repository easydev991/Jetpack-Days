# Экран 4.1: Create/Edit Item Screen (Создание и редактирование записей)

## Обзор

Create/Edit Item Screen предназначен для создания новой записи или редактирования существующей. Экран предоставляет форму ввода всех данных записи с валидацией и обработкой ошибок.

## Назначение

Создание новой записи или редактирование существующей с валидацией данных и сохранением в базе данных.

## Компоненты

1. **Заголовок экрана** (TopAppBar, createEditTopAppBar)

   - Для создания: "Новая запись"
   - Для редактирования: "Редактировать"

2. **Поле ввода "Название"** (titleSection, OutlinedTextField)

   - Заголовок: "Название"
   - Placeholder: "Название для записи"
   - Обязательное поле
   - Автофокус НЕ реализован

3. **Поле ввода "Описание"** (detailsSection, OutlinedTextField)

   - Заголовок: "Описание"
   - Placeholder: "Описание для записи"
   - Многострочное текстовое поле (minLines = 3)
   - Необязательное поле

4. **Выбор даты** (dateSection, datePickerDialogSection)

   - Заголовок: "Дата"
   - TextField с иконкой календаря (только для чтения)
   - DatePickerDialog при клике на иконку
   - По умолчанию: текущая дата

5. **Цветовая метка** (colorSelector)

   - Заголовок: "Цветовая метка"
   - Селектор из 6 предопределенных цветов
   - При повторном клике на выбранный цвет — сброс выбора (colorTag = null)
   - По умолчанию: без цвета (colorTag = null)
   - Визуальное выделение выбранного цвета (рамка)

6. **Опция отображения дней** (displayOptionSelector)

   - Заголовок: "Формат отображения"
   - Селектор из 3 опций:

     - "Только дни" (day)
     - "Дни и месяцы" (monthDay)
     - "Годы, месяцы и дни" (yearMonthDay)

   - По умолчанию: "Только дни" (day)
   - Визуальное отображение выбранной опции (галочка)

## Кнопки на Toolbar и форме

- **Кнопка "Отмена"** (placement: navigationIcon в TopAppBar)
  - Текст: "Отмена"
  - Возвращает к предыдущему экрану

- **Кнопка "Сохранить"** (placement: в форме, внизу)
  - Активна только если:

    - Название не пустое
    - Дата выбрана
    - При редактировании: есть изменения (проверка через `checkHasChanges()` в ViewModel)

## Валидация

- Название не может быть пустым
- Дата должна быть выбрана
- При редактировании кнопка "Сохранить" активна только если данные изменились

## Навигация

- Кнопка "Отмена" → возврат к предыдущему экрану
- Кнопка "Сохранить" → сохранение данных и возврат к предыдущему экрану

## Зависимости от других этапов

- Этап 7: Модель данных (Entity, Domain model, Room Database, DAO) — ЗАВЕРШЕН, готов к использованию
- Экран 2.1: Main Screen — РЕАЛИЗОВАН, навигация к экрану создания/редактирования настроена
- Экран 3.1: Item Screen — РЕАЛИЗОВАН, навигация к экрану редактирования настроена

---

## Подробный план реализации по TDD

### Шаг 1: Подготовка слоя домена (Domain Layer)

#### 1.1. Use Cases

Статус: НЕ ВЫПОЛНЕНО

Примечание: Логика в ViewModel, прямые вызовы Repository. Это соответствует прагматичному подходу для небольшого проекта.

**Задачи (опционально):**

1. Создать CreateItemUseCase, UpdateItemUseCase, GetItemByIdUseCase
2. Написать unit-тесты для Use Cases

**Критерии готовности:**

- Use Cases НЕ созданы
- Валидация реализована (в ViewModel)
- Unit-тесты НЕ написаны

---

### Шаг 2: Подготовка слоя представления (Presentation Layer)

#### 2.1. UI State

Статус: ВЫПОЛНЕНО

Что сделано: Создан `CreateEditUiState` (состояние полей формы) и `CreateEditScreenState` (Loading/Success/Error для экрана)

Файлы:

- `app/src/main/java/com/dayscounter/ui/screen/CreateEditUiState.kt`
- `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`

Критерии готовности:

- UI State создан
- `checkHasChanges()` реализован в ViewModel
- Валидация работает
- Unit-тесты НЕ написаны

---

#### 2.2. ViewModel

Статус: ВЫПОЛНЕНО

Что сделано: Создан `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`, `checkHasChanges()`, `resetHasChanges()`, обработка ошибок через `ItemException`, DI через `SavedStateHandle` и фабрику

Файл: `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`

Дополнительные возможности:

- `_originalItem` - хранение оригинальных данных для отслеживания изменений
- `_hasChanges` - StateFlow с признаком наличия изменений
- `checkHasChanges()` - сравнение всех полей с оригинальными данными
- `resetHasChanges()` - сброс состояния изменений

Критерии готовности:

- ViewModel создан
- Все методы реализованы
- Валидация работает
- Определение изменений реализовано
- DI через фабрику работает
- Unit-тесты НЕ написаны

---

### Шаг 3: Реализация UI компонентов

#### 3.1. Навигация

Статус: ВЫПОЛНЕНО

Что сделано: Маршруты `CreateItem` и `EditItem` в `Screen.kt`, навигация из Main Screen и Item Screen настроена, DI через фабрики

Файлы:

- `app/src/main/java/com/dayscounter/navigation/Screen.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/RootScreenComponents.kt`

Критерии готовности:

- Маршруты добавлены
- Навигация настроена
- DI работает
- Параметры передаются корректно

---

#### 3.2. Форма ввода данных

Статус: ВЫПОЛНЕНО

Что сделано: Основной экран `CreateEditScreen`, TopAppBar, все поля (Название, Описание, DatePicker, селектор цветов, селектор опций), кнопки действий

Отличия от iOS:

- Автофокус НЕ реализован
- Toggle заменен на селектор цветов (6 цветов + сброс при повторном клике)
- Предпросмотр дней закомментирован в UI

Файлы:

- `app/src/main/java/com/dayscounter/ui/screen/CreateEditScreen.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditFormContent.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditButtons.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditSelectors.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditFormParams.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditFormContentPreviews.kt`

Критерии готовности:

- Все компоненты созданы
- Валидация работает
- Все поля работают
- Селектор цветов работает (выбор + сброс)
- Селектор опций работает
- DatePicker работает
- Автофокус НЕ реализован

---

#### 3.3. Верстка компонентов

Статус: ВЫПОЛНЕНО

Что сделано: ScrollView с Column, отступы, Material Design 3, тема, иконки, адаптивность, поддержка темного режима

Критерии готовности:

- Верстка выполнена
- Адаптивность обеспечена
- Material Design 3 применен
- Темный режим поддерживается

---

### Шаг 4: Интеграция и обработка ошибок

#### 4.1. Сохранение данных

Статус: ВЫПОЛНЕНО

Что сделано: Методы `createItem()` и `updateItem()` в ViewModel, прямые вызовы Repository, обработка ошибок через `ItemException` (SaveFailed, UpdateFailed, LoadFailed), логирование ошибок, обновление состояния `Error` в ViewModel

Критерии готовности:

- Сохранение работает
- Обновление работает
- Обработка ошибок реализована
- Сообщения НЕ отображаются пользователю (только логирование)

---

#### 4.2. Загрузка данных при редактировании

Статус: ВЫПОЛНЕНО

Что сделано: Метод `loadItem()` в `init` блоке, вызов `repository.getItemById()`, сохранение в `_originalItem`, заполнение формы через `loadItemData()` в UI слое

Файлы:

- `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`
- `app/src/main/java/com/dayscounter/ui/screen/components/createedit/CreateEditFormContent.kt`

Критерии готовности:

- Загрузка работает
- Обработка ошибок реализована
- Данные загружаются корректно
- Оригинальные данные сохраняются для отслеживания изменений

---

#### 4.3. Определение изменений

Статус: ВЫПОЛНЕНО

Что сделано:

- В ViewModel добавлено поле `_originalItem` для хранения оригинальных данных
- В ViewModel добавлено поле `_hasChanges` (StateFlow[Boolean])
- Метод `checkHasChanges()` сравнивает все поля: title, details, timestamp, colorTag, displayOption
- В UI кнопка "Сохранить" использует `enabled = isValidData && hasChanges` при редактировании
- `loadItemData()` в UI слое вызывает `onValueChange()` для проверки изменений после загрузки данных

Критерии готовности:

- Определение изменений реализовано полностью
- Кнопка активируется корректно при редактировании
- Все поля сравниваются
- При успешном сохранении `_hasChanges` сбрасывается в false

---

### Шаг 5: Локализация

Статус: ВЫПОЛНЕНО

Что сделано: Все строки используют ресурсы проекта (`stringResource(R.string.*)`), поддержка русского и английского

Критерии готовности:

- Ресурсы используются
- Локализация работает
- Русский и английский поддерживаются

---

### Шаг 6: Финальное тестирование

Статус: ЧАСТИЧНО ВЫПОЛНЕНО

Что проверено (вручную): Форма в режимах создания/редактирования, валидация, DatePicker, селекторы, сохранение, кнопки, определение изменений

Что НЕ выполнено:

- Unit-тесты для ViewModel
- Unit-тесты для UI State
- UI тесты
- Интеграционные тесты

Критерии готовности:

- Ручное тестирование проведено
- Unit-тесты НЕ написаны
- UI тесты НЕ написаны
- Основные функции работают

---

## Реализация (детали)

### UI компоненты

- Использован вертикальный Column для основного макета
- Добавлен ScrollableColumn для прокрутки формы
- Реализованы поля ввода с заголовками и плейсхолдерами
- Селектор цветов (6 предопределенных цветов + сброс при повторном клике)
- Обеспечено адекватное отображение элементов при изменении ориентации экрана
- Обеспечено корректное поведение при вводе текста и выборе даты
- Подключено к ViewModel для управления состоянием формы
- Использованы современные компоненты Material Design 3
- Применена тема приложения с поддержкой темного режима
- Применены корректные иконки из Material Icons
- TopAppBar с заголовком и кнопкой "Назад"
- Кнопки "Отмена" и "Сохранить" с правильной валидацией
- Автофокус на поле "Название" НЕ реализован
- Предпросмотр дней закомментирован

### Архитектура

- Использован Room для локального хранения данных (через Repository)
- Реализован Repository Pattern для абстракции источников данных
- Use Cases НЕ использованы (логика в ViewModel)
- Применена Clean Architecture (Data → Domain → Presentation)
- Использован StateFlow для реактивного обновления UI
- DI через фабрику ViewModel (factory method)
- SavedStateHandle для получения параметров навигации
- Отслеживание изменений через originalItem и checkHasChanges()

---

## Тестирование

### Unit-тесты

Статус: НЕ ВЫПОЛНЕНО

Задачи:

- Тесты для CreateEditScreenViewModel

  - Инициализация (создание/редактирование)
  - Валидация (пустые поля)
  - Создание новой записи
  - Обновление существующей записи
  - Загрузка данных при редактировании
  - Отслеживание изменений (checkHasChanges)
  - Обработка ошибок (SaveFailed, UpdateFailed, LoadFailed)
  - Сброс состояния изменений (resetHasChanges)

**Файлы для создания:** `app/src/test/java/com/dayscounter/viewmodel/CreateEditScreenViewModelTest.kt`

### Интеграционные тесты

Статус: НЕ ВЫПОЛНЕНО

Задачи:

- Тесты взаимодействия ViewModel + Repository
- Тесты сохранения в базу данных
- Тесты загрузки из базы данных

### UI-тесты

Статус: НЕ ВЫПОЛНЕНО

Задачи:

- Форма (создание/редактирование)
- Валидация (пустые поля)
- DatePicker (выбор даты)
- Селектор цветов (выбор цвета, сброс)
- Селектор опций (выбор опции)
- Кнопки (отмена, сохранить)
- Отслеживание изменений при редактировании

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- Все компоненты созданы и работают
- Все unit-тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- Все интеграционные тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- Все UI-тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- Код соответствует правилам проекта
- Линтеры не проверены (требуется запуск ktlint, detekt)
- Валидация работает корректно
- Отслеживание изменений работает корректно
- Навигация работает корректно

**Текущий статус:** ОСНОВНАЯ ФУНКЦИОНАЛЬНОСТЬ РЕАЛИЗОВАНА В ПОЛНОМ ОБЪЕМЕ (включая отслеживание изменений), тесты не написаны

---

## Блокируемые этапы

Статус: БЛОКИРОВАНИЯ СНЯТЫ

Экраны, зависящие от этого этапа:

- Экран 2.1: Main Screen — использует CreateEditScreen для создания записей (реализовано)
- Экран 3.1: Item Screen — использует CreateEditScreen для редактирования записей (реализовано)

**Примечание:** Экран Create/Edit Item полностью функционален и интегрирован в проект. Реализовано отслеживание изменений при редактировании. Остаются только тесты.

---

## Примечания

1. **Валидация:** Название является обязательным полем, дата обязательна. Реализована на уровне UI (`enabled = title.isNotEmpty() && selectedDate != null`).

2. **Определение изменений:** Полностью реализовано. При редактировании кнопка "Сохранить" активна только если заполнены обязательные поля И есть реальные изменения по сравнению с исходными данными. Сравниваются все поля: title, details, timestamp, colorTag, displayOption.

3. **Автофокус:** Поле "Название" НЕ получает фокус автоматически при открытии экрана создания. Это требование из оригинального плана не реализовано.

4. **Обработка ошибок:** Все ошибки сохранения/загрузки обрабатываются и логируются, состояние `Error` обновляется в ViewModel, но сообщения об ошибках НЕ отображаются пользователю в UI (нет снекбара или диалога).

5. **Цветовая метка:** Реализована через селектор цветов (выбор конкретного цвета или сброс при повторном клике), а не через Toggle с показом/скрытием ColorPicker, как в iOS. Это допустимое отличие, но оно влияет на UX.

6. **Use Cases:** Не созданы. Бизнес-логика находится в ViewModel, которая вызывает методы Repository напрямую. Это соответствует прагматичному подходу для небольшого проекта.

7. **Тестирование:** Все компоненты НЕ покрыты тестами. Требуется написание unit-тестов для ViewModel, UI State, а также UI-тестов и интеграционных тестов.

8. **Зависимости:** Этап 7 (Модель данных) завершен и готов к использованию. Экран 2.1 (Main Screen) реализован. Экран 3.1 (Item Screen) реализован.

9. **Предпросмотр дней:** Закомментирован в `CreateEditFormContent.kt` (строки 154-161). Возможно, будет добавлен в будущем.

---

## Резюме реализации

### Что реализовано и работает

1. **Основной экран CreateEditScreen** — полнофункциональный экран создания и редактирования записей
2. **ViewModel** — `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`, `checkHasChanges()`, `resetHasChanges()`
3. **UI State** — `CreateEditUiState` для состояния формы и `CreateEditScreenState` для состояний экрана (Loading/Success/Error)
4. **Навигация** — маршруты `CreateItem` и `EditItem` в `Screen.kt`, интеграция с Main Screen и Item Screen
5. **Форма ввода**

   - Поле "Название" с валидацией
   - Поле "Описание" (многострочное)
   - DatePicker с диалогом выбора даты
   - Селектор цветовой метки (6 цветов + сброс при повторном клике)
   - Селектор опции отображения дней (3 опции)
   - Предпросмотр количества дней (закомментирован)

6. **Кнопки управления** — "Отмена" и "Сохранить" с правильной валидацией и учетом изменений при редактировании
7. **Локализация** — все строки используют ресурсы проекта, поддержка русского и английского
8. **Material Design 3** — все компоненты используют Material Design 3
9. **Интеграция с Repository** — прямые вызовы методов Repository для CRUD операций
10. **Обработка ошибок** — `ItemException` и логирование ошибок (SaveFailed, UpdateFailed, LoadFailed)
11. **Отслеживание изменений** — сохранение оригинальных данных, сравнение полей, активация кнопки "Сохранить" только при наличии изменений

### Что НЕ реализовано или требует доработки

1. **Unit-тесты для ViewModel** — файл `CreateEditScreenViewModelTest.kt` не создан
2. **Unit-тесты для UI State** — нет тестов для `CreateEditUiState`
3. **UI-тесты** — нет тестов Espresso или Compose Testing
4. **Интеграционные тесты** — нет тестов взаимодействия слоев
5. **Автофокус на поле "Название"** — не реализован (требование из оригинального плана)
6. **Отображение ошибок пользователю** — состояние `Error` обновляется, но UI не показывает ошибку (нет снекбара или диалога)
7. **Toggle для цветовой метки** — реализован селектор вместо Toggle с анимацией (отличие от iOS)
8. **Предпросмотр дней** — закомментирован в коде
9. **Use Cases** — не созданы (бизнес-логика в ViewModel)
10. **Линтеры** — не проверены (требуется запуск ktlint, detekt)

### Рекомендации по доработке

**Критично:**

- Написать unit-тесты для ViewModel (минимум 8-10 тестов)
- Проверить работу линтеров (`./gradlew ktlintCheck`, `./gradlew detekt`)

**Важно:**

- Реализовать отображение ошибок пользователю (снекбар или диалог при состоянии `Error`)
- Добавить автофокус на поле "Название" при создании новой записи (FocusState)

**Желательно:**

- Рассмотреть использование предпросмотра дней (раскомментировать код или реализовать новый вариант)
- Написать UI-тесты для критических сценариев
- Рассмотреть создание Use Cases для улучшения архитектуры (если проект вырастет)

### Оценка завершенности

- **Основная функциональность:** 95% (реализовано всё, включая отслеживание изменений)
- **Архитектура:** 80% (без Use Cases)
- **UI/UX:** 85% (недостает автофокуса, показа ошибок, предпросмотра дней)
- **Тестирование:** 0%
- **Качество кода:** 90% (не проверены линтеры)
- **Общая оценка:** 75% — Экран функционален, интегрирован и готов к использованию, основные требования выполнены, но отсутствуют тесты и есть несколько улучшений UX
