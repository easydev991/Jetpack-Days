# Экран 4.1: Create/Edit Item Screen (Создание и редактирование записей)

## Обзор

Create/Edit Item Screen предназначен для создания новой записи или редактирования существующей. Экран предоставляет форму ввода всех данных записи с валидацией и обработкой ошибок.

## Назначение

Создание новой записи или редактирование существующей с валидацией данных и сохранением в базу данных.

## Компоненты

1. **Заголовок экрана** (navigationTitle, navigationBarTitleDisplayMode: inline)
   - Для создания: "Новая запись"
   - Для редактирования: "Редактировать"
2. **Поле ввода "Название"** (EditSectionView)
   - Заголовок: "Название" (SectionTitleView)
   - Placeholder: "Название для записи"
   - Обязательное поле
   - Автофокус при открытии экрана (FocusState)
3. **Поле ввода "Описание"** (EditSectionView)
   - Заголовок: "Описание" (SectionTitleView)
   - Placeholder: "Описание для записи"
   - Многострочное текстовое поле
   - Необязательное поле
4. **Выбор даты** (ItemDatePicker)
   - Заголовок: "Дата" (SectionTitleView)
   - DatePicker с выбором даты (displayedComponents: date)
   - По умолчанию: текущая дата
5. **Цветовая метка**
   - Toggle: "Добавить цветовую метку" (SectionTitleView)
   - При включении — показывается ColorPicker с анимацией (transition: move + opacity)
   - При выключении — скрывается ColorPicker
   - По умолчанию: выключено (colorTag = null)
   - При включении: colorTag = .yellow (по умолчанию)
6. **Опция отображения дней** (ItemDisplayOptionPicker)
   - Заголовок: "Формат отображения" (SectionTitleView)
   - Picker с опциями:
     - "Только дни" (day)
     - "Дни и месяцы" (monthDay)
     - "Годы, месяцы и дни" (yearMonthDay)
   - По умолчанию: "Только дни" (day)

## Кнопки на Toolbar

- **Кнопка "Отмена" / "Закрыть"** (placement: topBarLeading)
  - Для создания: "Закрыть" (возвращает к списку)
  - Для редактирования: "Отмена" (возвращает к просмотру записи)
  - При редактировании: navigationBarBackButtonHidden = true
- **Кнопка "Сохранить"** (placement: topBarTrailing)
  - Активна только если:
    - Название не пустое
    - При редактировании: есть изменения (сравнение всех полей)

## Валидация

- Название не может быть пустым
- При редактировании кнопка "Сохранить" активна только если данные изменились

## Навигация

- Кнопка "Отмена/Закрыть" → возврат к предыдущему экрану
- Кнопка "Сохранить" → сохранение данных и возврат к предыдущему экрану

## Зависимости от других этапов

- ✅ **Этап 7**: Модель данных (Entity, Domain model, Room Database, DAO) — **ЗАВЕРШЕН**, готов к использованию
- ✅ **Экран 2.1**: Main Screen — **РЕАЛИЗОВАН**, навигация к экрану создания/редактирования настроена
- ✅ **Экран 3.1**: Item Screen — **РЕАЛИЗОВАН**, навигация к экрану редактирования настроена

---

## Подробный план реализации по TDD

### Шаг 1: Подготовка слоя домена (Domain Layer)

#### 1.1. Use Cases

**Статус: ⚠️ НЕ ВЫПОЛНЕНО** (логика в ViewModel, прямые вызовы Repository)

**Задачи (опционально):**
1. Создать CreateItemUseCase, UpdateItemUseCase, GetItemByIdUseCase
2. Написать unit-тесты для Use Cases

**Критерии готовности:**
- ⚠️ Use Cases НЕ созданы
- ✅ Валидация реализована (в ViewModel)
- ⚠️ Unit-тесты НЕ написаны

---

### Шаг 2: Подготовка слоя представления (Presentation Layer)

#### 2.1. UI State

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Создан `CreateEditUiState` и `CreateEditScreenState` (Loading/Success/Error)

**Файлы:**
- `app/src/main/java/com/dayscounter/ui/screen/CreateEditUiState.kt`
- `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`

**Критерии готовности:**
- ✅ UI State создан
- ⚠️ `hasChanges()` НЕ реализован (прямое сравнение в UI)
- ✅ Валидация работает
- ⚠️ Unit-тесты НЕ написаны

---

#### 2.2. ViewModel

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Создан `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`, обработка ошибок, DI через `SavedStateHandle`

**Файл:** `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`

**Критерии готовности:**
- ✅ ViewModel создан
- ✅ Все методы реализованы
- ✅ Валидация работает (на уровне UI)
- ⚠️ Unit-тесты НЕ написаны

---

### Шаг 3: Реализация UI компонентов

#### 3.1. Навигация

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Маршруты `CreateItem` и `EditItem` в `Screen.kt`, навигация из Main Screen и Item Screen настроена, DI через фабрики

**Файлы:** `Screen.kt`, `RootScreenComponents.kt`

**Критерии готовности:**
- ✅ Маршруты добавлены
- ✅ Навигация настроена
- ✅ DI работает
- ✅ Параметры передаются корректно

---

#### 3.2. Форма ввода данных

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Основной экран `CreateEditScreen`, Toolbar, все поля (Название, Описание, DatePicker, селектор цветов, селектор опций, предпросмотр дней)

**Отличия от iOS:** ❌ Автофокус НЕ реализован, ❌ Toggle заменен на селектор цветов, ❌ Анимация ColorPicker НЕ реализована

**Файлы:** `CreateEditScreen.kt`, `CreateEditUiState.kt`, 5 файлов в `components/createedit/`

**Критерии готовности:**
- ✅ Все компоненты созданы
- ✅ Валидация работает
- ✅ Все поля работают
- ⚠️ Автофокус НЕ реализован
- ⚠️ Toggle заменен на селектор

---

#### 3.3. Верстка компонентов

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** ScrollView, Column, отступы, Material Design 3, тема, иконки, адаптивность

**Критерии готовности:**
- ✅ Верстка выполнена
- ✅ Адаптивность обеспечена
- ✅ Material Design 3 применен

---

### Шаг 4: Интеграция и обработка ошибок

#### 4.1. Сохранение данных

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Методы `createItem()` и `updateItem()` в ViewModel, прямые вызовы Repository, обработка ошибок через `ItemException`, возврат к предыдущему экрану

**Критерии готовности:**
- ✅ Сохранение работает
- ✅ Обработка ошибок реализована
- ⚠️ Сообщения НЕ отображаются пользователю (только логирование)

---

#### 4.2. Загрузка данных при редактировании

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Метод `loadItem()` в `init` блоке, вызов `repository.getItemById()`, заполнение формы через `loadItemData()` в UI слое

**Файлы:** `CreateEditScreenViewModel.kt`, `CreateEditFormContent.kt`

**Критерии готовности:**
- ✅ Загрузка работает
- ✅ Обработка ошибок реализована
- ✅ Данные загружаются корректно

---

#### 4.3. Определение изменений

**Статус: ⚠️ ЧАСТИЧНО ВЫПОЛНЕНО**

**Что сделано:** Валидация `enabled = title.isNotEmpty() && selectedDate != null`

**Примечание:** Кнопка активна при заполненных полях, но НЕ проверяет реальные изменения

**Критерии готовности:**
- ✅ Валидация обязательных полей работает
- ⚠️ Определение изменений частично
- ⚠️ Кнопка активируется некорректно при редактировании

---

### Шаг 5: Локализация

**Статус: ✅ ВЫПОЛНЕНО**

**Что сделано:** Все строки используют ресурсы проекта, поддержка русского и английского

**Критерии готовности:**
- ✅ Ресурсы используются
- ✅ Локализация работает
- ✅ Русский и английский поддерживаются

---

### Шаг 6: Финальное тестирование

**Статус: ⚠️ ЧАСТИЧНО ВЫПОЛНЕНО**

**Что проверено (вручную):** Форма в режимах создания/редактирования, валидация, DatePicker, селекторы, сохранение, кнопки

**Что НЕ выполнено:**
- ❌ Unit-тесты для ViewModel
- ❌ Unit-тесты для UI State
- ❌ UI тесты
- ❌ Интеграционные тесты

**Критерии готовности:**
- ⚠️ Ручное тестирование проведено
- ❌ Unit-тесты НЕ написаны
- ❌ UI тесты НЕ написаны
- ✅ Основные функции работают

---

## Реализация (детали)

### UI компоненты
✅ Использован вертикальный Column для основного макета
✅ Добавлен ScrollableColumn для прокрутки формы
✅ Реализованы поля ввода с заголовками и плейсхолдерами
⚠️ Toggle заменен на селектор цветов
✅ Добавлен ColorPicker (селектор) с визуальным отображением выбранного цвета
✅ Обеспечено адекватное отображение элементов при изменении ориентации экрана
✅ Обеспечено корректное поведение при вводе текста и выборе даты
✅ Подключено к ViewModel для управления состоянием формы
✅ Использованы современные компоненты Material Design 3
✅ Применена тема приложения с поддержкой темного режима
✅ Применены корректные иконки из Material Icons

### Архитектура
✅ Использован Room для локального хранения данных (через Repository)
✅ Реализован Repository Pattern для абстракции источников данных
⚠️ Use Cases НЕ использованы (логика в ViewModel)
✅ Применена Clean Architecture (Data → Domain → Presentation)
✅ Использован StateFlow для реактивного обновления UI

---

## Тестирование

### Unit-тесты
**Статус: ❌ НЕ ВЫПОЛНЕНО**

**Задачи:**
- ❌ Тесты для CreateItemUseCase (Use Cases НЕ созданы)
- ❌ Тесты для UpdateItemUseCase (Use Cases НЕ созданы)
- ❌ Тесты для GetItemByIdUseCase (Use Cases НЕ созданы)
- ❌ Тесты для CreateEditScreenViewModel
  - Инициализация, валидация, сохранение, обновление, ошибки

**Файлы для создания:** `app/src/test/java/com/dayscounter/viewmodel/CreateEditScreenViewModelTest.kt`

### Интеграционные тесты
**Статус: ❌ НЕ ВЫПОЛНЕНО**

### UI-тесты
**Статус: ❌ НЕ ВЫПОЛНЕНО**

**Задачи:** Форма (создание/редактирование), валидация, DatePicker, селекторы, сохранение, кнопки

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ⚠️ Все unit-тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- ❌ Все интеграционные тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- ❌ Все UI-тесты написаны и проходят (НЕ ВЫПОЛНЕНО)
- ✅ Код соответствует правилам проекта
- ⚠️ Линтеры не проверены (требуется запуск ktlint, detekt)
- ✅ Валидация работает корректно (на уровне UI)
- ✅ Навигация работает корректно

**Текущий статус:** ⚠️ ОСНОВНАЯ ФУНКЦИОНАЛЬНОСТЬ РЕАЛИЗОВАНА, тесты не написаны

---

## Блокируемые этапы

**Статус: ✅ БЛОКИРОВАНИЯ СНЯТЫ**

Экраны, зависящие от этого этапа:
- ✅ Экран 2.1: Main Screen — использует CreateEditScreen для создания записей (реализовано)
- ✅ Экран 3.1: Item Screen — использует CreateEditScreen для редактирования записей (реализовано)

**Примечание:** Экран Create/Edit Item полностью функционален и интегрирован в проект. Остаются только тесты.

---

## Примечания

1. **Валидация**: ✅ Название является обязательным полем, форма не может быть сохранена без него. Реализована на уровне UI (`enabled = title.isNotEmpty() && selectedDate != null`).

2. **Определение изменений**: ⚠️ При редактировании кнопка "Сохранить" активна если заполнены обязательные поля, но НЕ проверяет наличие реальных изменений по сравнению с исходными данными. Требуется доработка для UX, аналогичного iOS.

3. **Автофокус**: ❌ Поле "Название" НЕ получает фокус автоматически при открытии экрана создания. Это требование из оригинального плана не реализовано.

4. **Обработка ошибок**: ⚠️ Все ошибки сохранения обрабатываются и логируются, но сообщения об ошибках НЕ отображаются пользователю. Состояние `Error` обновляется в ViewModel, но UI не отображает ошибку.

5. **Цветовая метка**: ⚠️ Реализована через селектор цветов (выбор конкретного цвета или отказ), а не через Toggle с показом/скрытием ColorPicker, как в iOS. Это допустимое отличие, но оно влияет на UX.

6. **Use Cases**: ❌ Не созданы. Бизнес-логика находится в ViewModel, которая вызывает методы Repository напрямую. Это соответствует прагматичному подходу для небольшого проекта.

7. **Тестирование**: ❌ Все компоненты НЕ покрыты тестами. Требуется написание unit-тестов для ViewModel и UI State, а также UI-тестов.

8. **Зависимости**: ✅ Этап 7 (Модель данных) завершен и готов к использованию. ✅ Экран 2.1 (Main Screen) реализован. ✅ Экран 3.1 (Item Screen) реализован.

---

## Резюме реализации

### Что реализовано и работает:

1. ✅ **Основной экран CreateEditScreen** — полнофункциональный экран создания и редактирования записей
2. ✅ **ViewModel** — `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`
3. ✅ **UI State** — `CreateEditUiState` для состояния формы и `CreateEditScreenState` для состояний экрана
4. ✅ **Навигация** — маршруты `CreateItem` и `EditItem` в `Screen.kt`, интеграция с Main Screen и Item Screen
5. ✅ **Форма ввода**:
   - ✅ Поле "Название" с валидацией
   - ✅ Поле "Описание" (многострочное)
   - ✅ DatePicker с диалогом выбора даты
   - ✅ Селектор цветовой метки (6 цветов + опция без цвета)
   - ✅ Селектор опции отображения дней (3 опции)
   - ✅ Предпросмотр количества дней
6. ✅ **Кнопки управления** — "Отмена" и "Сохранить" с правильной валидацией
7. ✅ **Локализация** — все строки используют ресурсы проекта, поддержка русского и английского
8. ✅ **Material Design 3** — все компоненты используют Material Design 3
9. ✅ **Интеграция с Repository** — прямые вызовы методов Repository для CRUD операций
10. ✅ **Обработка ошибок** — `ItemException` и логирование ошибок

### Что НЕ реализовано или требует доработки:

1. ❌ **Unit-тесты для ViewModel** — файл `CreateEditScreenViewModelTest.kt` не создан
2. ❌ **Unit-тесты для UI State** — нет тестов для `CreateEditUiState`
3. ❌ **UI-тесты** — нет тестов Espresso или Compose Testing
4. ❌ **Интеграционные тесты** — нет тестов взаимодействия слоев
5. ⚠️ **Автофокус на поле "Название"** — не реализован (требование из оригинального плана)
6. ⚠️ **Определение изменений при редактировании** — кнопка "Сохранить" активна даже если данные не изменились
7. ⚠️ **Отображение ошибок пользователю** — состояние `Error` обновляется, но UI не показывает ошибку
8. ⚠️ **Toggle для цветовой метки** — реализован селектор вместо Toggle с анимацией (отличие от iOS)
9. ❌ **Use Cases** — не созданы (бизнес-логика в ViewModel)

### Рекомендации по доработке:

1. **Критично:**
   - ✅ Написать unit-тесты для ViewModel (минимум 5-10 тестов)
   - ✅ Проверить работу линтеров (`./gradlew ktlintCheck`, `./gradlew detekt`)

2. **Важно:**
   - ✅ Реализовать отображение ошибок пользователю (снекбар или диалог при состоянии `Error`)
   - ✅ Добавить автофокус на поле "Название" при создании новой записи

3. **Желательно:**
   - ✅ Реализовать определение изменений при редактировании (хранить исходные данные и сравнивать)
   - ✅ Написать UI-тесты для критических сценариев
   - ✅ Рассмотреть создание Use Cases для улучшения архитектуры (если проект вырастет)

### Оценка завершенности:

- **Основная функциональность:** 90% ✅
- **Архитектура:** 80% ✅ (без Use Cases)
- **UI/UX:** 75% ⚠️ (недостает автофокуса, определения изменений, показа ошибок)
- **Тестирование:** 0% ❌
- **Общая оценка:** 70% ⚠️ — **Экран функционален и готов к использованию, но требует доработок для полного соответствия плану**
