# Экран 4.1: Create/Edit Item Screen (Создание и редактирование записей)

## Обзор

Create/Edit Item Screen предназначен для создания новой записи или редактирования существующей. Экран предоставляет форму ввода всех данных записи с валидацией и обработкой ошибок.

## Назначение

Создание новой записи или редактирование существующей с валидацией данных и сохранением в базе данных.

## Компоненты

1. **Заголовок экрана** (TopAppBar, createEditTopAppBar)
   - Для создания: "Новая запись"
   - Для редактирования: "Редактировать"

2. **Поле ввода "Название"** (titleSection, OutlinedTextField)
   - Обязательное поле
   - Автофокус НЕ реализован

3. **Поле ввода "Описание"** (detailsSection, OutlinedTextField)
   - Многострочное текстовое поле (minLines = 3)
   - Необязательное поле

4. **Выбор даты** (dateSection, datePickerDialogSection)
   - TextField с иконкой календаря (только для чтения)
   - DatePickerDialog при клике на иконку
   - По умолчанию: текущая дата

5. **Цветовая метка** (colorSelector)
   - Селектор из 6 предопределенных цветов
   - При повторном клике на выбранный цвет — сброс выбора (colorTag = null)
   - По умолчанию: без цвета (colorTag = null)

6. **Опция отображения дней** (displayOptionSelector)
   - "Только дни" (day)
   - "Дни и месяцы" (monthDay)
   - "Годы, месяцы и дни" (yearMonthDay)
   - По умолчанию: "Только дни" (day)

## Кнопки на Toolbar и форме

- **Кнопка "Отмена"** (placement: navigationIcon в TopAppBar) — Возвращает к предыдущему экрану
- **Кнопка "Сохранить"** (placement: в форме, внизу) — Активна только если название не пустое, дата выбрана, и при редактировании есть изменения

## Валидация

- Название не может быть пустым
- Дата должна быть выбрана
- При редактировании кнопка "Сохранить" активна только если данные изменились

## Навигация

- Кнопка "Отмена" → возврат к предыдущему экрану
- Кнопка "Сохранить" → сохранение данных и возврат к предыдущему экрану

## Зависимости от других этапов

- Этап 7: Модель данных — ЗАВЕРШЕН
- Экран 2.1: Main Screen — РЕАЛИЗОВАН
- Экран 3.1: Item Screen — РЕАЛИЗОВАН

---

## Подробный план реализации по TDD

### Шаг 1: Подготовка слоя представления (Presentation Layer) ✅

**UI State:** `CreateEditUiState` (состояние формы), `CreateEditScreenState` (Loading/Success/Error)

**ViewModel:** `CreateEditScreenViewModel` — методы createItem(), updateItem(), loadItem(), checkHasChanges(), resetHasChanges(), отслеживание изменений, обработка ошибок через ItemException, DI через SavedStateHandle

---

### Шаг 2: Реализация UI компонентов ✅

**Навигация:** маршруты `CreateItem` и `EditItem` в `Screen.kt`, интеграция с Main Screen и Item Screen

**Форма ввода:** основной экран CreateEditScreen со всеми полями, кнопками и валидацией. Отличия от iOS: автофокус НЕ реализован, Toggle заменен на селектор цветов, предпросмотр дней закомментирован

**Верстка:** ScrollView с Column, отступы, Material Design 3, тема, иконки, адаптивность, поддержка темного режима

---

### Шаг 3: Интеграция и обработка ошибок ✅

**Сохранение данных:** методы createItem() и updateItem() в ViewModel, прямые вызовы Repository, обработка ошибок через ItemException, логирование ошибок

**Загрузка данных при редактировании:** метод loadItem() в init блоке, вызов repository.getItemById(), заполнение формы через loadItemData()

**Определение изменений:** поле _originalItem для хранения оригинальных данных, поле _hasChanges, метод checkHasChanges() сравнивает все поля, кнопка "Сохранить" активна только при наличии изменений

---

### Шаг 4: Тестирование

#### 4.1. Unit-тесты для ViewModel ✅ ВЫПОЛНЕНО

Файл: `app/src/test/java/com/dayscounter/viewmodel/CreateEditScreenViewModelTest.kt`

Протестированы: инициализация, валидация, создание/обновление записей, загрузка данных, отслеживание изменений, обработка ошибок, сброс состояния изменений

Результаты: 16 тестов, все проходят, покрытие > 70%

---

#### 4.2. Unit-тесты для UI State ✅ ВЫПОЛНЕНО

Файл: `app/src/test/java/com/dayscounter/ui/screen/CreateEditUiStateTest.kt`

Протестированы: создание UI State с дефолтными значениями, изменение всех полей, переключение DatePicker, обработка null значений

Результаты: 15 тестов, все проходят

---

#### 4.3. Интеграционные тесты

Статус: **НЕ ВЫПОЛНЕНО**

Что нужно протестировать:

- Взаимодействие ViewModel + Repository
- Сохранение в базу данных
- Загрузка из базы данных

Критерии готовности:

- Все тесты написаны
- Все тесты проходят
- Основные сценарии взаимодействия покрыты

---

#### 4.4. UI-тесты

Статус: **НЕ ВЫПОЛНЕНО**

Что нужно протестировать:

- Форма (создание/редактирование)
- Валидация (пустые поля)
- DatePicker (выбор даты)
- Селектор цветов (выбор цвета, сброс)
- Селектор опций (выбор опции)
- Кнопки (отмена, сохранить)
- Отслеживание изменений при редактировании

Критерии готовности:

- Все тесты написаны
- Все тесты проходят
- Основные пользовательские сценарии покрыты

---

### Шаг 5: Локализация ✅

Все строки используют ресурсы проекта (`stringResource(R.string.*)`), поддержка русского и английского

---

### Шаг 6: Качество кода ✅

Код соответствует правилам проекта, KDoc документация для публичных API, линтеры проверены (ktlint, detekt), форматирование применено

---

### Шаг 7: Финальное тестирование ✅

Проверено вручную: форма в режимах создания/редактирования, валидация, DatePicker, селекторы, сохранение, кнопки, определение изменений

Что выполнено: unit-тесты (31 тест: 16 для ViewModel + 15 для UI State), проверка линтеров

Что НЕ выполнено: UI тесты, интеграционные тесты

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ✅ Все unit-тесты написаны и проходят (31 тест: 16 для ViewModel + 15 для UI State)
- ❌ Все интеграционные тесты написаны и проходят
- ❌ Все UI-тесты написаны и проходят
- ✅ Код соответствует правилам проекта (проверка линтерами)
- ✅ Валидация работает корректно
- ✅ Отслеживание изменений работает корректно
- ✅ Навигация работает корректно

**Текущий статус:** ОСНОВНАЯ ФУНКЦИОНАЛЬНОСТЬ РЕАЛИЗОВАНА В ПОЛНОМ ОБЪЕМЕ (включая отслеживание изменений), unit-тесты (31 тест) и проверка линтеров ВЫПОЛНЕНЫ, остаются только UI-тесты и интеграционные тесты

---

## Блокируемые этапы

Статус: **БЛОКИРОВАНИЯ СНЯТЫ**

Экраны, зависящие от этого этапа:

- ✅ Экран 2.1: Main Screen — использует CreateEditScreen для создания записей (реализовано)
- ✅ Экран 3.1: Item Screen — использует CreateEditScreen для редактирования записей (реализовано)

**Примечание:** Экран Create/Edit Item полностью функционален и интегрирован в проект. Реализовано отслеживание изменений при редактировании. Unit-тесты (31 тест) и проверка линтеров выполнены. Остаются только UI-тесты и интеграционные тесты.

---

## Примечания

1. **Валидация:** Название является обязательным полем, дата обязательна. Реализована на уровне UI (`enabled = title.isNotEmpty() && selectedDate != null`).

2. **Определение изменений:** Полностью реализовано. При редактировании кнопка "Сохранить" активна только если заполнены обязательные поля И есть реальные изменения по сравнению с исходными данными. Сравниваются все поля: title, details, timestamp, colorTag, displayOption.

3. **Автофокус:** Поле "Название" НЕ получает фокус автоматически при открытии экрана создания. Это требование из оригинального плана не реализовано.

4. **Обработка ошибок:** Все ошибки сохранения/загрузки обрабатываются и логируются, состояние `Error` обновляется в ViewModel, но сообщения об ошибках НЕ отображаются пользователю в UI (нет снекбара или диалога).

5. **Цветовая метка:** Реализована через селектор цветов (выбор конкретного цвета или сброс при повторном клике), а не через Toggle с показом/скрытием ColorPicker, как в iOS. Это допустимое отличие, но оно влияет на UX.

6. **Use Cases:** Не созданы. Бизнес-логика находится в ViewModel, которая вызывает методы Repository напрямую. Это соответствует прагматичному подходу для небольшого проекта.

7. **Тестирование:** Unit-тесты для ViewModel (16 тестов) и UI State (15 тестов) написаны и проходят. UI-тесты и интеграционные тесты НЕ реализованы.

8. **Зависимости:** Этап 7 (Модель данных) завершен и готов к использованию. Экран 2.1 (Main Screen) реализован. Экран 3.1 (Item Screen) реализован.

9. **Предпросмотр дней:** Закомментирован в `CreateEditFormContent.kt` (строки 154-161). Возможно, будет добавлен в будущем.

10. **Качество кода:** Линтеры (ktlint, detekt) проверены и проходят без ошибок. Форматирование применено.

---

## Резюме реализации

### Что реализовано и работает

Основной экран CreateEditScreen, ViewModel (CreateEditScreenViewModel), UI State, навигация, форма ввода с валидацией, кнопки управления, локализация, Material Design 3, интеграция с Repository, обработка ошибок, отслеживание изменений, unit-тесты (31 тест), проверка линтеров

### Что НЕ реализовано или требует доработки

UI-тесты, интеграционные тесты, автофокус на поле "Название", отображение ошибок пользователю, Toggle для цветовой метки (реализован селектор), предпросмотр дней, Use Cases

### Рекомендации по доработке

**Важно:** реализовать отображение ошибок пользователю, добавить автофокус на поле "Название"

**Желательно:** рассмотреть использование предпросмотра дней, написать UI-тесты для критических сценариев, рассмотреть создание Use Cases

### Оценка завершенности

- **Основная функциональность:** 95%
- **Архитектура:** 80%
- **UI/UX:** 85%
- **Тестирование:** 40% (31 unit-тест)
- **Качество кода:** 95%
- **Общая оценка:** 80%
