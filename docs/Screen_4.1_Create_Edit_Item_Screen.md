# Экран 4.1: Create/Edit Item Screen (Создание и редактирование записей)

## Обзор

Create/Edit Item Screen предназначен для создания новой записи или редактирования существующей. Экран предоставляет форму ввода всех данных записи с валидацией и обработкой ошибок.

## Назначение

Создание новой записи или редактирование существующей с валидацией данных и сохранением в базе данных.

## Компоненты

1. **Заголовок экрана** (TopAppBar, createEditTopAppBar)
   - Для создания: "Новая запись"
   - Для редактирования: "Редактировать"

2. **Поле ввода "Название"** (titleSection, OutlinedTextField)
   - Обязательное поле
   - Автофокус НЕ реализован

3. **Поле ввода "Описание"** (detailsSection, OutlinedTextField)
   - Многострочное текстовое поле (minLines = 3)
   - Необязательное поле

4. **Выбор даты** (dateSection, datePickerDialogSection)
   - TextField с иконкой календаря (только для чтения)
   - DatePickerDialog при клике на иконку
   - По умолчанию: текущая дата

5. **Цветовая метка** (colorSelector)
   - Селектор из 6 предопределенных цветов
   - При повторном клике на выбранный цвет — сброс выбора (colorTag = null)
   - По умолчанию: без цвета (colorTag = null)

6. **Опция отображения дней** (displayOptionSelector)
   - "Только дни" (day)
   - "Дни и месяцы" (monthDay)
   - "Годы, месяцы и дни" (yearMonthDay)
   - По умолчанию: "Только дни" (day)

## Кнопки на Toolbar и форме

- **Кнопка "Отмена"** (placement: navigationIcon в TopAppBar) — Возвращает к предыдущему экрану
- **Кнопка "Сохранить"** (placement: в форме, внизу) — Активна только если название не пустое, дата выбрана, и при редактировании есть изменения

## Валидация

- Название не может быть пустым
- Дата должна быть выбрана
- При редактировании кнопка "Сохранить" активна только если данные изменились

## Навигация

- Кнопка "Отмена" → возврат к предыдущему экрану
- Кнопка "Сохранить" → сохранение данных и возврат к предыдущему экрану

## Зависимости от других этапов

- Этап 7: Модель данных — ЗАВЕРШЕН
- Экран 2.1: Main Screen — РЕАЛИЗОВАН
- Экран 3.1: Item Screen — РЕАЛИЗОВАН

---

## Подробный план реализации по TDD

### Шаг 1: Подготовка слоя представления (Presentation Layer) ✅ ВЫПОЛНЕНО

#### 1.1. UI State ✅
- Создан `CreateEditUiState` (состояние полей формы) и `CreateEditScreenState` (Loading/Success/Error для экрана)
- Файлы: `app/src/main/java/com/dayscounter/ui/screen/CreateEditUiState.kt`, `CreateEditScreenViewModel.kt`

#### 1.2. ViewModel ✅
- Создан `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`, `checkHasChanges()`, `resetHasChanges()`
- Реализована обработка ошибок через `ItemException`
- DI через `SavedStateHandle` и фабрику
- Отслеживание изменений: `_originalItem`, `_hasChanges`, `checkHasChanges()`, `resetHasChanges()`
- Файл: `app/src/main/java/com/dayscounter/viewmodel/CreateEditScreenViewModel.kt`

---

### Шаг 2: Реализация UI компонентов ✅ ВЫПОЛНЕНО

#### 2.1. Навигация ✅
- Маршруты `CreateItem` и `EditItem` в `Screen.kt`
- Настроена навигация из Main Screen и Item Screen
- DI через фабрики

#### 2.2. Форма ввода данных ✅
- Основной экран `CreateEditScreen`, TopAppBar, все поля (Название, Описание, DatePicker, селектор цветов, селектор опций), кнопки действий
- Отличия от iOS: автофокус НЕ реализован, Toggle заменен на селектор цветов, предпросмотр дней закомментирован
- Файлы: `CreateEditScreen.kt`, `CreateEditFormContent.kt`, `CreateEditButtons.kt`, `CreateEditSelectors.kt`, `CreateEditFormParams.kt`, `CreateEditFormContentPreviews.kt`

#### 2.3. Верстка компонентов ✅
- ScrollView с Column, отступы, Material Design 3, тема, иконки, адаптивность, поддержка темного режима

---

### Шаг 3: Интеграция и обработка ошибок ✅ ВЫПОЛНЕНО

#### 3.1. Сохранение данных ✅
- Методы `createItem()` и `updateItem()` в ViewModel
- Прямые вызовы Repository, обработка ошибок через `ItemException`
- Логирование ошибок, обновление состояния `Error` в ViewModel
- Сообщения НЕ отображаются пользователю (только логирование)

#### 3.2. Загрузка данных при редактировании ✅
- Метод `loadItem()` в `init` блоке
- Вызов `repository.getItemById()`, сохранение в `_originalItem`
- Заполнение формы через `loadItemData()` в UI слое

#### 3.3. Определение изменений ✅
- В ViewModel добавлено поле `_originalItem` для хранения оригинальных данных
- В ViewModel добавлено поле `_hasChanges` (StateFlow[Boolean])
- Метод `checkHasChanges()` сравнивает все поля: title, details, timestamp, colorTag, displayOption
- В UI кнопка "Сохранить" использует `enabled = isValidData && hasChanges` при редактировании
- `loadItemData()` в UI слое вызывает `onValueChange()` для проверки изменений после загрузки данных

---

### Шаг 4: Тестирование

#### 4.1. Unit-тесты для ViewModel

Статус: **НЕ ВЫПОЛНЕНО**

Что нужно протестировать:

- Инициализация (создание/редактирование)
- Валидация (пустые поля)
- Создание новой записи
- Обновление существующей записи
- Загрузка данных при редактировании
- Отслеживание изменений (checkHasChanges)
- Обработка ошибок (SaveFailed, UpdateFailed, LoadFailed)
- Сброс состояния изменений (resetHasChanges)

**Файл для создания:** `app/src/test/java/com/dayscounter/viewmodel/CreateEditScreenViewModelTest.kt`

Критерии готовности:

- Все тесты написаны
- Все тесты проходят
- Покрытие основных сценариев > 70%

---

#### 4.2. Интеграционные тесты

Статус: **НЕ ВЫПОЛНЕНО**

Что нужно протестировать:

- Взаимодействие ViewModel + Repository
- Сохранение в базу данных
- Загрузка из базы данных

Критерии готовности:

- Все тесты написаны
- Все тесты проходят
- Основные сценарии взаимодействия покрыты

---

#### 4.3. UI-тесты

Статус: **НЕ ВЫПОЛНЕНО**

Что нужно протестировать:

- Форма (создание/редактирование)
- Валидация (пустые поля)
- DatePicker (выбор даты)
- Селектор цветов (выбор цвета, сброс)
- Селектор опций (выбор опции)
- Кнопки (отмена, сохранить)
- Отслеживание изменений при редактировании

Критерии готовности:

- Все тесты написаны
- Все тесты проходят
- Основные пользовательские сценарии покрыты

---

### Шаг 5: Локализация ✅ ВЫПОЛНЕНО

- Все строки используют ресурсы проекта (`stringResource(R.string.*)`)
- Поддержка русского и английского

---

### Шаг 6: Качество кода

Статус: **ЧАСТИЧНО ВЫПОЛНЕНО**

Что сделано:

- Код соответствует правилам проекта
- KDoc документация для публичных API

Что НЕ выполнено:

- Линтеры не проверены (ktlint, detekt)
- Форматирование не проверено

Критерии готовности:

- `./gradlew ktlintCheck` проходит без ошибок
- `./gradlew detekt` проходит без критических ошибок
- `make format` успешно применен

---

### Шаг 7: Финальное тестирование

Статус: **ЧАСТИЧНО ВЫПОЛНЕНО**

Что проверено (вручную):

- Форма в режимах создания/редактирования
- Валидация
- DatePicker
- Селекторы
- Сохранение
- Кнопки
- Определение изменений

Что НЕ выполнено:

- Unit-тесты для ViewModel
- UI тесты
- Интеграционные тесты
- Проверка линтеров

Критерии готовности:

- Ручное тестирование проведено ✅
- Unit-тесты написаны и проходят ❌
- UI тесты написаны и проходят ❌
- Линтеры проверены ❌
- Основные функции работают ✅

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ❌ Все unit-тесты написаны и проходят
- ❌ Все интеграционные тесты написаны и проходят
- ❌ Все UI-тесты написаны и проходят
- ❌ Код соответствует правилам проекта (проверка линтерами)
- ✅ Валидация работает корректно
- ✅ Отслеживание изменений работает корректно
- ✅ Навигация работает корректно

**Текущий статус:** ОСНОВНАЯ ФУНКЦИОНАЛЬНОСТЬ РЕАЛИЗОВАНА В ПОЛНОМ ОБЪЕМЕ (включая отслеживание изменений), тесты и проверка линтеров НЕ ВЫПОЛНЕНЫ

---

## Блокируемые этапы

Статус: **БЛОКИРОВАНИЯ СНЯТЫ**

Экраны, зависящие от этого этапа:

- ✅ Экран 2.1: Main Screen — использует CreateEditScreen для создания записей (реализовано)
- ✅ Экран 3.1: Item Screen — использует CreateEditScreen для редактирования записей (реализовано)

**Примечание:** Экран Create/Edit Item полностью функционален и интегрирован в проект. Реализовано отслеживание изменений при редактировании. Остаются только тесты и проверка линтеров.

---

## Примечания

1. **Валидация:** Название является обязательным полем, дата обязательна. Реализована на уровне UI (`enabled = title.isNotEmpty() && selectedDate != null`).

2. **Определение изменений:** Полностью реализовано. При редактировании кнопка "Сохранить" активна только если заполнены обязательные поля И есть реальные изменения по сравнению с исходными данными. Сравниваются все поля: title, details, timestamp, colorTag, displayOption.

3. **Автофокус:** Поле "Название" НЕ получает фокус автоматически при открытии экрана создания. Это требование из оригинального плана не реализовано.

4. **Обработка ошибок:** Все ошибки сохранения/загрузки обрабатываются и логируются, состояние `Error` обновляется в ViewModel, но сообщения об ошибках НЕ отображаются пользователю в UI (нет снекбара или диалога).

5. **Цветовая метка:** Реализована через селектор цветов (выбор конкретного цвета или сброс при повторном клике), а не через Toggle с показом/скрытием ColorPicker, как в iOS. Это допустимое отличие, но оно влияет на UX.

6. **Use Cases:** Не созданы. Бизнес-логика находится в ViewModel, которая вызывает методы Repository напрямую. Это соответствует прагматичному подходу для небольшого проекта.

7. **Тестирование:** Все компоненты НЕ покрыты тестами. Требуется написание unit-тестов для ViewModel, а также UI-тестов и интеграционных тестов.

8. **Зависимости:** Этап 7 (Модель данных) завершен и готов к использованию. Экран 2.1 (Main Screen) реализован. Экран 3.1 (Item Screen) реализован.

9. **Предпросмотр дней:** Закомментирован в `CreateEditFormContent.kt` (строки 154-161). Возможно, будет добавлен в будущем.

10. **Качество кода:** Линтеры (ktlint, detekt) не проверены. Требуется запуск `./gradlew ktlintCheck` и `./gradlew detekt`.

---

## Резюме реализации

### Что реализовано и работает

1. **Основной экран CreateEditScreen** — полнофункциональный экран создания и редактирования записей
2. **ViewModel** — `CreateEditScreenViewModel` с методами `createItem()`, `updateItem()`, `loadItem()`, `checkHasChanges()`, `resetHasChanges()`
3. **UI State** — `CreateEditUiState` для состояния формы и `CreateEditScreenState` для состояний экрана (Loading/Success/Error)
4. **Навигация** — маршруты `CreateItem` и `EditItem` в `Screen.kt`, интеграция с Main Screen и Item Screen
5. **Форма ввода** — Поле "Название" с валидацией, поле "Описание" (многострочное), DatePicker с диалогом выбора даты, селектор цветовой метки (6 цветов + сброс при повторном клике), селектор опции отображения дней (3 опции), предпросмотр количества дней (закомментирован)
6. **Кнопки управления** — "Отмена" и "Сохранить" с правильной валидацией и учетом изменений при редактировании
7. **Локализация** — все строки используют ресурсы проекта, поддержка русского и английского
8. **Material Design 3** — все компоненты используют Material Design 3
9. **Интеграция с Repository** — прямые вызовы методов Repository для CRUD операций
10. **Обработка ошибок** — `ItemException` и логирование ошибок (SaveFailed, UpdateFailed, LoadFailed)
11. **Отслеживание изменений** — сохранение оригинальных данных, сравнение полей, активация кнопки "Сохранить" только при наличии изменений

### Что НЕ реализовано или требует доработки

1. **Unit-тесты для ViewModel** — файл `CreateEditScreenViewModelTest.kt` не создан
2. **Unit-тесты для UI State** — нет тестов для `CreateEditUiState`
3. **UI-тесты** — нет тестов Espresso или Compose Testing
4. **Интеграционные тесты** — нет тестов взаимодействия слоев
5. **Автофокус на поле "Название"** — не реализован (требование из оригинального плана)
6. **Отображение ошибок пользователю** — состояние `Error` обновляется, но UI не показывает ошибку (нет снекбара или диалога)
7. **Toggle для цветовой метки** — реализован селектор вместо Toggle с анимацией (отличие от iOS)
8. **Предпросмотр дней** — закомментирован в коде
9. **Use Cases** — не созданы (бизнес-логика в ViewModel)
10. **Проверка линтеров** — не выполнена (требуется запуск ktlint, detekt)

### Рекомендации по доработке

**Критично:**

- Написать unit-тесты для ViewModel (минимум 8-10 тестов)
- Проверить работу линтеров (`./gradlew ktlintCheck`, `./gradlew detekt`)

**Важно:**

- Реализовать отображение ошибок пользователю (снекбар или диалог при состоянии `Error`)
- Добавить автофокус на поле "Название" при создании новой записи (FocusState)

**Желательно:**

- Рассмотреть использование предпросмотра дней (раскомментировать код или реализовать новый вариант)
- Написать UI-тесты для критических сценариев
- Рассмотреть создание Use Cases для улучшения архитектуры (если проект вырастет)

### Оценка завершенности

- **Основная функциональность:** 95% (реализовано всё, включая отслеживание изменений)
- **Архитектура:** 80% (без Use Cases)
- **UI/UX:** 85% (недостает автофокуса, показа ошибок, предпросмотра дней)
- **Тестирование:** 0%
- **Качество кода:** 90% (не проверены линтеры)
- **Общая оценка:** 70% — Экран функционален, интегрирован и готов к использованию, основные требования выполнены, но отсутствуют тесты и проверка линтеров
