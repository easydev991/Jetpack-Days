# Экран 5.3: App Data Screen (Управление данными приложения)

## Обзор

App Data Screen предназначен для управления данными приложения, включая создание резервных копий, восстановление из резервных копий и удаление всех данных. Экран обеспечивает совместимость формата резервных копий с iOS-приложением.

## Назначение

Управление данными приложения: создание резервных копий, восстановление из резервных копий и удаление всех данных с подтверждением действий.

## Компоненты

1. **Заголовок экрана** — "Данные приложения"
2. **Кнопка "Создать резервную копию"** (если есть записи)
   - Открывает FilePicker для сохранения JSON-файла
   - Имя файла по умолчанию: "Days backup"
   - Формат: JSON
   - **ВАЖНО:** Структура файла должна быть совместима с iOS-приложением
3. **Кнопка "Восстановить из резервной копии"**
   - Открывает FilePicker для выбора JSON-файла
   - Загружает записи из файла
   - Добавляет только новые записи (не дублирует существующие)
   - **ВАЖНО:** Формат файла должен быть совместим с iOS-приложением
4. **Кнопка "Удалить все данные"** (если есть записи)
   - Стиль: деструктивный (красный цвет)
   - Требует подтверждения действия
   - Удаляет все записи из базы данных

## Диалоги подтверждения

- **Диалог удаления данных**
  - Заголовок: "Удалить все данные?"
  - Сообщение: "Вы хотите удалить все данные безвозвратно?"
  - Кнопки: "Удалить" (деструктивная), "Отмена"

## Диалоги результатов

- **Успешное создание бэкапа**
  - Заголовок: "Готово"
  - Сообщение: "Резервная копия сохранена"
- **Успешное восстановление**
  - Заголовок: "Готово"
  - Сообщение: "Данные восстановлены из резервной копии"
- **Успешное удаление**
  - Заголовок: "Готово"
  - Сообщение: "Все данные удалены"
- **Ошибка восстановления**
  - Заголовок: "Ошибка"
  - Сообщение: "Не удалось восстановить данные из выбранного файла"

## Навигация

- Кнопка "Назад" → Screen 5.1 (More Screen)

## Зависимости от других этапов

- ⚠️ **Требуется Этап 7**: Модель данных (Entity, Domain model, Room Database, DAO) — необходимо для работы с данными
- ⚠️ **Требуется Этап 7**: Repository — необходимо для операций с данными
- ⚠️ **Требуется Экран 5.1**: More Screen — должен быть реализован для навигации к AppData Screen

---

## Подробный план реализации по TDD

**ВАЖНО:** Реализация экрана зависит от завершения Этапа 7 (Модель данных). Необходимо сначала реализовать Room Entity, DAO, Database и Repository.

---

### Шаг 1: Структура и навигация

#### 1.1. Добавление маршрута

**Задачи:**
1. Добавить маршрут `AppData` в `navigation/Screen.kt`
2. Создать отдельный файл `AppDataScreen.kt` в `ui/screen/`
3. Реализовать навигацию к экрану из Screen 5.1 (More Screen)
4. Добавить кнопку "Назад" с навигацией к Screen 5.1

**Критерии готовности:**
- ✅ Маршрут добавлен
- ✅ Файл AppDataScreen.kt создан
- ✅ Навигация настроена

---

### Шаг 2: ViewModel

#### 2.1. Создание ViewModel

**Задачи:**
1. Создать `AppDataViewModel` для управления операциями с данными
2. Реализовать проверку наличия записей в базе данных
3. Реализовать состояние UI для операций (Loading/Success/Error)
4. Использовать `viewModelScope` для корутин
5. Написать unit-тесты для ViewModel

**Структура:**
```kotlin
sealed class AppDataScreenUiState {
    object Idle : AppDataScreenUiState()
    object Loading : AppDataScreenUiState()
    data class Success(val message: String) : AppDataScreenUiState()
    data class Error(val message: String) : AppDataScreenUiState()
}

data class AppDataScreenState(
    val hasItems: Boolean = false,
    val uiState: AppDataScreenUiState = AppDataScreenUiState.Idle
)
```

**Критерии готовности:**
- ✅ ViewModel создан
- ✅ Проверка наличия записей работает
- ✅ Состояния UI реализованы
- ✅ Unit-тесты написаны и проходят

---

### Шаг 3: Функциональность резервного копирования (экспорт)

#### 3.1. Реализация экспорта

**Задачи:**
1. Реализовать экспорт всех записей в JSON формат
2. Обеспечить совместимость формата с iOS-приложением:
   - Структура: массив объектов с полями `title`, `details`, `timestamp`, `colorTag`, `displayOption`
   - Формат `colorTag`: **Data (Base64-строка)** - сериализованный UIColor через NSKeyedArchiver (как в iOS)
   - Формат `displayOption`: строка ("day", "monthDay", "yearMonthDay") - enum значения в camelCase
   - Формат `timestamp`: число (миллисекунды с 1970-01-01) - Date в iOS сериализуется как timestamp
3. Интегрировать FilePicker для сохранения файла
4. Установить имя файла по умолчанию: "Days backup"
5. Реализовать обработку ошибок при экспорте
6. Написать unit-тесты для экспорта

**Структура JSON (совместимая с iOS):**
```json
[
  {
    "title": "Название события",
    "details": "Описание события",
    "timestamp": 1234567890000,
    "colorTag": "<Base64-encoded Data from NSKeyedArchiver>",
    "displayOption": "day"
  }
]
```

**ВАЖНО:** 
- `colorTag` в iOS хранится как Data (NSKeyedArchiver), а не как строка цвета
- При импорте нужно поддерживать оба формата: Data (новый) и старый формат (если был)
- `displayOption` использует camelCase: "day", "monthDay", "yearMonthDay"

**Критерии готовности:**
- ✅ Экспорт реализован
- ✅ Формат совместим с iOS
- ✅ FilePicker интегрирован
- ✅ Обработка ошибок реализована
- ✅ Unit-тесты написаны и проходят

---

### Шаг 4: Функциональность восстановления (импорт)

#### 4.1. Реализация импорта

**Задачи:**
1. Интегрировать FilePicker для выбора JSON-файла
2. Реализовать парсинг JSON файла с валидацией структуры
3. Реализовать проверку совместимости формата с iOS-приложением:
   - Поддержка формата `colorTag` как Data (Base64) - основной формат iOS
   - Поддержка обратной совместимости со старым форматом (если был)
   - Корректная десериализация `displayOption` (camelCase: "day", "monthDay", "yearMonthDay")
4. Реализовать добавление только новых записей (предотвращение дубликатов):
   - Сравнение записей по всем полям (title, details, timestamp, colorTag, displayOption)
   - Добавление только тех записей, которых нет в текущей базе
5. Реализовать обработку ошибок при импорте (неверный формат, поврежденный файл)
6. Написать unit-тесты для импорта, включая тесты совместимости с iOS-форматом

**Критерии готовности:**
- ✅ Импорт реализован
- ✅ Валидация формата работает
- ✅ Предотвращение дубликатов работает
- ✅ Обработка ошибок реализована
- ✅ Unit-тесты написаны и проходят

---

### Шаг 5: Функциональность удаления данных

#### 5.1. Реализация удаления

**Задачи:**
1. Реализовать удаление всех записей из базы данных через Repository
2. Добавить подтверждение действия через диалог
3. Реализовать обработку ошибок при удалении
4. Написать unit-тесты для удаления

**Критерии готовности:**
- ✅ Удаление реализовано
- ✅ Подтверждение работает
- ✅ Обработка ошибок реализована
- ✅ Unit-тесты написаны и проходят

---

### Шаг 6: UI компоненты

#### 6.1. Создание UI компонентов

**Задачи:**
1. Создать список кнопок действий с данными приложения
2. Реализовать кнопку "Создать резервную копию" (активна только при наличии записей)
3. Реализовать кнопку "Восстановить из резервной копии" (всегда активна)
4. Реализовать кнопку "Удалить все данные" с деструктивным стилем (красный цвет, активна только при наличии записей)
5. Реализовать диалог подтверждения удаления данных
6. Реализовать диалоги результатов операций (успех/ошибка)
7. Написать UI тесты для компонентов

**Критерии готовности:**
- ✅ Все UI компоненты созданы
- ✅ Кнопки активируются/деактивируются корректно
- ✅ Диалоги работают
- ✅ UI тесты написаны

---

### Шаг 7: Верстка компонентов

#### 7.1. Финальная верстка

**Задачи:**
1. Использовать вертикальный Column для основного макета
2. Добавить кнопки действий с соответствующими стилями
3. Обеспечить визуальное выделение деструктивных действий (удаление)
4. Обеспечить адаптивность компоновки при изменении ориентации экрана
5. Применить корректные иконки из Material Icons
6. Применить тему приложения с поддержкой темного режима

**Критерии готовности:**
- ✅ Верстка выполнена
- ✅ Адаптивность обеспечена
- ✅ Тема применена

---

### Шаг 8: Локализация

**Задачи:**
1. Использовать готовые строковые ресурсы из `Localization_Plan.md`:
   - Заголовок экрана: `app_data`
   - Названия кнопок: `create_a_backup`, `restore_from_backup`, `delete_all_data`
   - Тексты диалогов подтверждения: `do_you_want_to_delete_all_data_permanently`
   - Тексты диалогов результатов: `backup_data_saved`, `data_restored_from_backup`, `all_data_deleted`, `unable_to_recover_data_from_the_selected_file`
   - Сообщения об ошибках: `error`, `done`, `ok`
2. Поддержка русского и английского языков (уже реализована в `Localization_Plan.md`)

**Критерии готовности:**
- ✅ Используются готовые строковые ресурсы
- ✅ Локализация работает корректно

**Примечание:** План локализации готов в документе `Localization_Plan.md`. Все строки определены и готовы к использованию.

---

### Шаг 9: Финальное тестирование

**Задачи:**
1. Проверить создание резервной копии (экспорт в JSON) (unit + UI тесты)
2. Проверить восстановление из резервной копии (импорт из JSON) (unit + UI тесты)
3. Проверить предотвращение дубликатов при восстановлении (unit + UI тесты)
4. Проверить удаление всех данных с подтверждением (unit + UI тесты)
5. Проверить корректное отображение диалогов подтверждения и результатов (UI тесты)
6. Проверить корректную навигацию назад (UI тесты)
7. Проверить, что кнопки активируются/деактивируются в зависимости от наличия записей (UI тесты)
8. Проверить обработку ошибок при экспорте/импорте (unit + UI тесты)
9. Проверить совместимость формата резервной копии с iOS-приложением (интеграционные тесты)

**Критерии готовности:**
- ✅ Все тесты проходят
- ✅ Все функции работают корректно

---

## Реализация (детали)

### UI компоненты
- Использовать вертикальный Column для основного макета
- Добавить кнопки действий с соответствующими стилями
- Обеспечить визуальное выделение деструктивных действий (удаление)
- Добавить диалоги подтверждения с заголовками и кнопками
- Обеспечить адаптивность компоновки при изменении ориентации экрана
- Использовать современные компоненты Material Design 3
- Применить тему приложения с поддержкой темного режима
- Применить корректные иконки из Material Icons

### Архитектура
- Использовать Room для локального хранения данных (через Repository)
- Использовать Coroutines для асинхронных операций
- Реализовать обработку ошибок и состояний загрузки
- Применить Clean Architecture (Data → Domain → Presentation)
- Использовать Use Cases для бизнес-логики (если требуется)

---

## Тестирование

### Unit-тесты
- Тесты для экспорта в JSON (формат, совместимость с iOS)
- Тесты для импорта из JSON (валидация, предотвращение дубликатов)
- Тесты для удаления всех данных
- Тесты для ViewModel (логика операций, состояния)

### Интеграционные тесты
- Тесты взаимодействия ViewModel с Repository
- Тесты совместимости формата резервной копии с iOS-приложением

### UI-тесты
- Проверить создание резервной копии (экспорт в JSON)
- Проверить восстановление из резервной копии (импорт из JSON)
- Проверить предотвращение дубликатов при восстановлении
- Проверить удаление всех данных с подтверждением
- Проверить корректное отображение диалогов подтверждения и результатов
- Проверить корректную навигацию назад
- Проверить, что кнопки активируются/деактивируются в зависимости от наличия записей
- Проверить обработку ошибок при экспорте/импорте

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ✅ Все unit-тесты написаны и проходят
- ✅ Все интеграционные тесты написаны и проходят
- ✅ Все UI-тесты написаны и проходят
- ✅ Код соответствует правилам проекта
- ✅ Линтеры не выдают ошибок
- ✅ Формат резервной копии совместим с iOS-приложением
- ✅ Все операции с данными работают корректно

---

## Блокируемые этапы

После завершения этого экрана можно приступать к:
- Нет блокируемых этапов — это финальный экран управления данными

---

## Примечания

1. **Совместимость с iOS**: Формат резервной копии должен быть полностью совместим с iOS-приложением для обеспечения возможности обмена данными между платформами.
   - **ColorTag**: В iOS хранится как Data (NSKeyedArchiver), в JSON экспортируется как Base64-строка
   - **DisplayOption**: Используется camelCase ("day", "monthDay", "yearMonthDay")
   - **Timestamp**: Миллисекунды с 1970-01-01
   - При импорте необходимо поддерживать оба формата: новый (Data/Base64) и старый (если был)

2. **Предотвращение дубликатов**: При восстановлении из резервной копии необходимо проверять существующие записи и добавлять только новые, чтобы избежать дубликатов.

3. **Обработка ошибок**: Все операции с файлами должны обрабатывать ошибки (неверный формат, поврежденный файл, проблемы с доступом к файлам).

4. **Подтверждение действий**: Деструктивные действия (удаление всех данных) должны требовать подтверждения от пользователя.

5. **Тестирование**: Все компоненты должны быть покрыты тестами, включая проверку совместимости формата с iOS-приложением.

6. **Зависимости**: Реализация зависит от завершения Этапа 7 (Модель данных) и Экрана 5.1 (More Screen).
