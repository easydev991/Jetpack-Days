# Экран 5.3: App Data Screen (Управление данными приложения)

## Обзор

App Data Screen предназначен для управления данными приложения, включая создание резервных копий, восстановление из резервных копий и удаление всех данных. Экран обеспечивает совместимость формата резервных копий с iOS-приложением.

## Назначение

Управление данными приложения: создание резервных копий, восстановление из резервных копий и удаление всех данных с подтверждением действий.

## Компоненты и навигация

**Кнопки:**

- **"Создать резервную копию"** (показывается только если есть записи)
- **"Восстановить из резервной копии"** (всегда доступна)
- **"Удалить все данные"** (показывается только если есть записи, деструктивный стиль)

**Логика отображения (как в iOS версии):**

- Если есть записи → 3 кнопки
- Если нет записей → 1 кнопка ("Восстановить из резервной копии")

**Навигация:** Кнопка "Назад" → Screen 5.1 (More Screen)

## Зависимости от других этапов

- ✅ **Этап 7**: Модель данных (Entity, Domain model, Room Database, DAO) — **ЗАВЕРШЕН**, готов к использованию
- ✅ **Этап 7**: Repository — **ЗАВЕРШЕН**, готов к использованию
- ✅ **Экран 5.1 реализован**: More Screen уже создан (`app/src/main/java/com/dayscounter/ui/screen/MoreScreen.kt`)
- ✅ **Навигация обновлена**: Кнопка "Данные приложения" на More Screen настроена для навигации к AppData Screen

---

## Подробный план реализации по TDD

**ВАЖНО:** ✅ Этап 7 (Модель данных) завершен. Room Entity, DAO, Database и Repository готовы к использованию.

---

### Шаг 1: Структура и навигация

#### 1.1. Добавление маршрута

**Задачи:**

1. Добавить маршрут `AppData` в `navigation/Screen.kt`
2. Создать отдельный файл `AppDataScreen.kt` в `ui/screen/`
3. Обновить навигацию на Screen 5.1 (More Screen) — заменить заглушку на реальную навигацию:

   ```kotlin
   // В MoreScreen.kt (строки 101-105)
   // Заменить:
   onClick = { Log.d("MoreScreen", "TODO: открыть экран AppData Screen") }
   // На:
   onClick = {
       navController?.navigate(Screen.AppData.route) {
           popUpTo(Screen.More.route)
       }
   }
   ```

4. Добавить кнопку "Назад" в AppData Screen с навигацией к Screen 5.1 (More Screen)

**Примечание:** More Screen уже полностью реализован, включая кнопку "Данные приложения" с реальной навигацией к AppData Screen.

**Критерии готовности:**

- ⏳ Маршрут `AppData` добавлен в `navigation/Screen.kt`
- ⏳ Файл `AppDataScreen.kt` создан в `ui/screen/`
- ✅ Заглушка на More Screen заменена на реальную навигацию к AppData Screen
- ⏳ Кнопка "Назад" в AppData Screen настроена для возврата к More Screen

---

### Шаг 2: ViewModel

#### 2.1. Создание ViewModel

**Критерии готовности:**

- ✅ ViewModel создан с проверкой наличия записей и состояниями UI
- ✅ Unit-тесты написаны и проходят

---

### Шаг 3: Функциональность резервного копирования (экспорт)

#### 3.1. Реализация экспорта

**Критерии готовности:**

- ✅ Экспорт с форматом, совместимым с iOS, и FilePicker интегрирован
- ✅ Unit-тесты и обработка ошибок реализованы

**Примечания по формату совместимости с iOS:**

- Структура: массив объектов с полями `title`, `details`, `timestamp` (число, мс), `colorTag` (Base64 Data), `displayOption` (camelCase)

---

### Шаг 4: Функциональность восстановления (импорт)

#### 4.1. Реализация импорта

**Критерии готовности:**

- ✅ Импорт с валидацией формата и предотвращением дубликатов
- ✅ Unit-тесты и обработка ошибок реализованы

**Примечания по совместимости с iOS:**

- Поддержка `colorTag` как Data (Base64) с обратной совместимостью
- Корректная десериализация `displayOption` (camelCase)

---

### Шаг 5: Функциональность удаления данных

#### 5.1. Реализация удаления

**Критерии готовности:**

- ✅ Удаление с подтверждением и обработкой ошибок
- ✅ Unit-тесты написаны и проходят

---

### Шаг 6: UI и верстка

#### 6.1. Реализация UI

**Архитектура верстки (по образцу ThemeIconScreen):**

- Scaffold + TopAppBar с заголовком "Данные приложения" и кнопкой "Назад"
- Вертикальная прокрутка с автоматической адаптивностью при повороте экрана
- Отступы: `padding(paddingValues)` + `padding(16.dp)` для контента
- Интервалы: `verticalArrangement = Arrangement.spacedBy(16.dp)`
- Кнопки: `FilledTonalButton`, `Modifier.fillMaxWidth()`
- Разделение компонентов: `appDataScreenContent` для UI-тестов в изоляции

**Android-специфичные компоненты:**

- AlertDialog для подтверждения удаления
- Toast для результатов операций (успех/ошибка)
- FilePicker для экспорта/импорта JSON-файлов

**Локализация:** Использовать готовые строковые ресурсы из проекта

**Критерии готовности:**

- ✅ UI реализован по образцу ThemeIconScreen с логикой отображения кнопок (1 или 3)
- ✅ AlertDialog, Toast и UI тесты для `appDataScreenContent` работают

---

### Шаг 7: Тестирование

#### 7.1. Unit-тесты

Экспорт/импорт JSON (формат, валидация, дубликаты), удаление данных, ViewModel (логика, состояния, `hasItems`)

#### 7.2. Интеграционные тесты

Взаимодействие ViewModel с Repository, совместимость формата с iOS

#### 7.3. UI-тесты (по образцу ThemeIconScreen)

Проверять `appDataScreenContent` в изоляции без ViewModel:

- Отображение: AppBar ("Данные приложения", кнопка "Назад"), 3 кнопки при `hasItems = true`, 1 кнопка при `hasItems = false`
- Взаимодействие: нажатия вызывают соответствующие callback'и

**Критерии готовности:**

- ✅ Все тесты проходят

---

## Критерии завершения этапа

Этап считается завершенным, когда:

- ✅ Все компоненты созданы и работают
- ✅ Все тесты (unit, integration, UI) написаны и проходят
- ✅ Код соответствует правилам проекта и проходит линтеры
- ✅ Формат резервной копии совместим с iOS-приложением

---

## Блокируемые этапы

После завершения этого экрана можно приступать к:

- Нет блокируемых этапов — это финальный экран управления данными

---

## Примечания

**Совместимость с iOS:**

- **ColorTag**: хранится как Data (NSKeyedArchiver), в JSON экспортируется как Base64-строка
- **DisplayOption**: camelCase ("day", "monthDay", "yearMonthDay")
- **Timestamp**: миллисекунды с 1970-01-01

**Отличия от iOS:**

- Android использует `Toast` для результатов операций вместо `alert`
- Android использует `AlertDialog` для подтверждения вместо `confirmationDialog`
- Логика отображения кнопок идентична iOS версии (3 или 1 кнопка)

**Архитектура верстки:** по образцу ThemeIconScreen (Scaffold + TopAppBar, verticalScroll, 16.dp отступы, FilledTonalButton)

**Зависимости:** ✅ Этап 7 (Модель данных) завершен. ✅ Экран 5.1 (More Screen) реализован.
