# План исправления Instrumented-тестов

## Цель
Исправить все instrumented-тесты, чтобы они успешно запускались и проходили на эмуляторе Pixel 9.

## Текущее состояние

### Активные instrumented-тесты:
1. **ExampleInstrumentedTest** - простой тест контекста приложения
2. **ItemDaoTest** - интеграционные тесты Room DAO (11 тестов)
3. **ItemRepositoryIntegrationTest** - интеграционные тесты репозитория (8 тестов)
4. **DaysDatabaseTest** - тесты структуры БД (2 теста)
5. **DaysCountTextTest** - UI-тесты Compose компонента (7 тестов)

**Всего: 29 тестов**

### Проблемы:
- ❌ Эмулятор Pixel 9 не подключен или не запущен
- ❌ ADB не найден в PATH (или не настроен)
- ❌ Тесты не могут запуститься из-за "device offline"
- ❌ Нет автоматизации запуска эмулятора перед тестами
- ❌ Нет конфигурации для выбора конкретного эмулятора

---

## Этап 1: Диагностика и проверка окружения

### Задачи:
1. **Проверить наличие Android SDK и ADB**
   - Найти путь к Android SDK (обычно `~/Library/Android/sdk`)
   - Проверить наличие `adb` в `$ANDROID_HOME/platform-tools/`
   - Добавить ADB в PATH, если отсутствует

2. **Проверить доступные эмуляторы**
   - Запустить `$ANDROID_HOME/emulator/emulator -list-avds`
   - Найти эмулятор Pixel 9 (имя может быть `Pixel_9` или похожее)
   - Проверить статус: `adb devices`

3. **Проверить компиляцию тестов**
   - Запустить `./gradlew compileDebugAndroidTestKotlin`
   - Убедиться, что все тесты компилируются без ошибок
   - Проверить зависимости в `build.gradle.kts`

### Ожидаемый результат:
- ADB доступен в PATH
- Эмулятор Pixel 9 найден в списке AVD
- Все тесты успешно компилируются

---

## Этап 2: Настройка эмулятора Pixel 9

### Задачи:
1. **Проверить конфигурацию эмулятора**
   - Убедиться, что эмулятор Pixel 9 существует
   - Проверить версию Android (должна быть совместима с minSdk=26)
   - Проверить, что эмулятор загружается корректно

2. **Создать скрипт для автоматического запуска эмулятора**
   - Создать скрипт `scripts/start-emulator.sh` или добавить в Makefile
   - Скрипт должен:
     - Проверять, запущен ли эмулятор
     - Если нет - запускать Pixel 9
     - Ждать полной загрузки эмулятора (boot completed)
     - Проверять подключение через ADB

3. **Добавить команду в Makefile**
   - `make emulator-start` - запуск эмулятора
   - `make emulator-stop` - остановка эмулятора
   - `make emulator-wait` - ожидание загрузки эмулятора

### Ожидаемый результат:
- Эмулятор Pixel 9 запускается автоматически
- Эмулятор полностью загружается перед запуском тестов
- ADB видит эмулятор как подключенное устройство

---

## Этап 3: Исправление конфигурации тестов

### Задачи:
1. **Проверить testInstrumentationRunner**
   - Убедиться, что в `build.gradle.kts` указан правильный runner:
     ```kotlin
     testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
     ```

2. **Проверить зависимости для тестов**
   - Убедиться, что все необходимые зависимости подключены:
     - `androidx.test.ext:junit`
     - `androidx.test.espresso:espresso-core`
     - `androidx.compose.ui:ui-test-junit4`
     - `androidx.compose.ui:ui-test-manifest`

3. **Проверить AndroidManifest для тестов**
   - Убедиться, что есть `src/androidTest/AndroidManifest.xml` (если нужен)
   - Проверить разрешения и конфигурацию

4. **Проверить использование ApplicationProvider**
   - Убедиться, что все тесты используют правильный способ получения Context:
     ```kotlin
     ApplicationProvider.getApplicationContext<Context>()
     ```

### Ожидаемый результат:
- Все тесты имеют правильную конфигурацию
- Все зависимости подключены корректно
- Context получается правильно во всех тестах

---

## Этап 4: Исправление проблем в тестах

### Задачи:
1. **Проверить ExampleInstrumentedTest**
   - ✅ Уже исправлен (package name изменен на `com.dayscounter`)
   - Проверить, что тест проходит

2. **Проверить ItemDaoTest**
   - Убедиться, что все тесты используют правильный Context
   - Проверить, что Room in-memory database создается правильно
   - Проверить, что все тесты закрывают БД в `@After`

3. **Проверить ItemRepositoryIntegrationTest**
   - Убедиться, что `ItemRepositoryImpl` доступен для тестов
   - Проверить правильность создания репозитория
   - Проверить все методы репозитория

4. **Проверить DaysDatabaseTest**
   - Убедиться, что тесты создают БД корректно
   - Проверить доступность DAO

5. **Проверить DaysCountTextTest**
   - Убедиться, что Compose тесты используют правильный Rule
   - Проверить, что компонент `daysCountText` доступен
   - Проверить все тесты на корректность

### Ожидаемый результат:
- Все тесты исправлены и готовы к запуску
- Нет ошибок компиляции
- Нет логических ошибок в тестах

---

## Этап 5: Настройка автоматизации запуска тестов

### Задачи:
1. **Обновить Makefile**
   - Добавить команду `make test-android`:
     - Проверяет/запускает эмулятор
     - Ждет загрузки
     - Запускает `./gradlew connectedDebugAndroidTest`
     - Показывает результаты

2. **Добавить обработку ошибок**
   - Если эмулятор недоступен - показать понятное сообщение
   - Если тесты падают - показать детали ошибок
   - Если эмулятор не загружается - показать инструкцию

3. **Добавить команду для проверки эмулятора**
   - `make emulator-check` - проверяет статус эмулятора
   - Показывает список доступных устройств
   - Показывает статус подключения

### Ожидаемый результат:
- Команда `make test-android` автоматически запускает эмулятор и тесты
- Все ошибки обрабатываются корректно
- Результаты тестов отображаются понятно

---

## Этап 6: Запуск и проверка всех тестов

### Задачи:
1. **Запустить все instrumented-тесты**
   - `make test-android` или `./gradlew connectedDebugAndroidTest`
   - Проверить, что все 29 тестов запускаются

2. **Проверить результаты**
   - Убедиться, что все тесты проходят
   - Если есть падающие тесты - исправить их
   - Проверить время выполнения тестов

3. **Проверить отчеты**
   - Открыть HTML отчеты в `app/build/reports/androidTests/`
   - Проверить детали каждого теста
   - Убедиться, что нет предупреждений

### Ожидаемый результат:
- Все 29 instrumented-тестов успешно проходят
- Время выполнения тестов приемлемое
- Отчеты генерируются корректно

---

## Этап 7: Интеграция в общий процесс тестирования

### Задачи:
1. **Обновить команду `make test`**
   - Запускать unit-тесты
   - Пытаться запустить instrumented-тесты (если эмулятор доступен)
   - Показывать результаты обоих типов тестов

2. **Добавить в CI/CD (если применимо)**
   - Настроить автоматический запуск эмулятора в CI
   - Настроить запуск всех тестов в pipeline

3. **Документировать процесс**
   - Добавить инструкцию в README или документацию
   - Описать, как запускать тесты вручную
   - Описать, как настроить эмулятор

### Ожидаемый результат:
- Команда `make test` запускает все типы тестов
- Процесс тестирования документирован
- CI/CD настроен (если применимо)

---

## Критерии завершения

Проект будет считаться завершенным, когда:

- [x] ADB настроен и доступен в PATH
- [ ] Эмулятор Pixel 9 запускается автоматически
- [ ] Все 29 instrumented-тестов компилируются без ошибок
- [ ] Все 29 instrumented-тестов успешно проходят
- [ ] Команда `make test-android` работает корректно
- [ ] Команда `make test` включает instrumented-тесты
- [ ] Процесс тестирования документирован

---

## Примечания

1. **Эмулятор Pixel 9**: Пользователь использует Pixel 9 для ручных тестов, поэтому нужно убедиться, что именно этот эмулятор используется для автоматических тестов.

2. **ADB PATH**: На macOS ADB обычно находится в `~/Library/Android/sdk/platform-tools/adb`. Нужно добавить в PATH или использовать полный путь.

3. **Время загрузки эмулятора**: Эмулятор может загружаться 30-60 секунд. Нужно добавить ожидание полной загрузки перед запуском тестов.

4. **Параллельный запуск**: Если есть несколько эмуляторов, нужно убедиться, что тесты запускаются на правильном устройстве.

5. **Очистка после тестов**: После завершения тестов можно автоматически закрывать эмулятор (опционально).

---

## Следующие шаги

1. ⏭️ Выполнить Этап 1: Диагностика и проверка окружения
2. ⏭️ Выполнить Этап 2: Настройка эмулятора Pixel 9
3. ⏭️ Выполнить Этап 3: Исправление конфигурации тестов
4. ⏭️ Выполнить Этап 4: Исправление проблем в тестах
5. ⏭️ Выполнить Этап 5: Настройка автоматизации запуска тестов
6. ⏭️ Выполнить Этап 6: Запуск и проверка всех тестов
7. ⏭️ Выполнить Этап 7: Интеграция в общий процесс тестирования
