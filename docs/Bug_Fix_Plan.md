# План исправления багов после внедрения DI через Factory Methods

**Дата создания:** 2025-01-02  
**Статус:** В ПРОЦЕССЕ РАБОТЫ

---

## Обзор проблем

После внедрения factory методов для CreateEditScreenViewModel и DetailScreenViewModel обнаружены следующие проблемы, требующие исправления:

1. ✅ **Баг #1**: DetailScreen не обновляется после редактирования (ИСПРАВЛЕН)
2. ✅ **Баг #2**: Toolbar перекрывает контент списка (ИСПРАВЛЕН)
3. ✅ **Баг #3**: Удаление записей работает некорректно (ИСПРАВЛЕН)
4. ✅ **Баг #4**: Поиск не работает (ИСПРАВЛЕН)
5. ❌ **Баг #5**: Список поиска не учитывает безопасную зону при повороте экрана и поиск закрывается
6. ✅ **Баг #6**: Неправильная верстка ListItemView (ИСПРАВЛЕН)
7. ✅ **Баг #7**: Нижняя навигация не видна (ИСПРАВЛЕН)
8. ✅ **Баг #8**: Контент заезжает под камеру (ИСПРАВЛЕН)
9. ✅ **Баг #9**: Изменение displayOption не обновляет UI (ИСПРАВЛЕН)
10. ✅ **Баг #10**: Свайп слева направо открывает несколько экранов редактирования (ИСПРАВЛЕН)
11. ✅ **Баг #11**: Состояние свайпа не сбрасывается при отмене удаления в диалоговом окне (ИСПРАВЛЕН)
12. ✅ **Баг #12**: Кнопка "Сохранить" активна без изменений (ИСПРАВЛЕН)
13. ✅ **Баг #13**: Заголовок экрана создания/редактирования всегда одинаковый (ИСПРАВЛЕН)
14. ✅ **Баг #14**: Месяцы игнорируются в MONTH_DAY и YEAR_MONTH_DAY (ИСПРАВЛЕН)
15. ✅ **Баг #15**: DetailScreen игнорирует displayOption (ИСПРАВЛЕН)

---

|| Баг | Приоритет | Влияние | Сложность | Оценка |
||------|------------|-----------|----------|----------|---------|
|| #1   | Высокий    | Высокое   | Средняя   | 2-3 ч   |
|| #2   | Высокий    | Высокое   | Низкая    | 1-2 ч    |
|| #3   | Высокий    | Высокое   | Низкая    | 1-2 ч    |
|| #4   | Высокий    | Высокое   | Средняя   | 2-3 ч    |
|| #5   | Высокий    | Среднее   | Низкая    | 1-2 ч    |
|| #6   | Средний    | Среднее   | Низкая    | 1 ч       |
|| #7   | Средний    | Среднее   | Низкая    | 1 ч       |
|| #8   | Средний    | Среднее   | Низкая    | 1-2 ч     |
|| #9   | Низкий     | Низкое    | Низкая    | 1-2 ч     |
|| #10  | Высокий    | Высокое   | Средняя   | 2-3 ч     |
|| #11  | Высокий    | Высокое   | Средняя   | 2-3 ч     |
|| #12  | Средний    | Среднее   | Средняя   | 2-3 ч     |
|| #13  | Низкий     | Низкое    | Низкая    | 0.5-1 ч   |
|| #14  | Высокий    | Высокое   | Средняя   | 2-3 ч     |
|| #15  | Высокий    | Высокое   | Низкая    | 1-2 ч     |

---

## Исправленные баги

Дата исправления: 2025-01-02

- **Баг #3, #10, #11:** Свайп заменен на долгое нажатие с DropdownMenu (View, Edit, Delete).
- **Баг #1:** DetailScreen обновляется после редактирования.
- **Баг #2:** Добавлен параметр `paddingValues` и `contentPadding` к LazyColumn.
- **Баг #7, #8:** В RootScreen заменен `Column` на `Scaffold`, NavigationBar в `bottomBar`, `paddingValues` к NavHost.
- **Баг #4:** Поиск исправлен.
- **Баг #6:** Контент разделен на две части (70%/30%), `maxLines = 2` и `TextOverflow.Ellipsis` для названия и описания.
- **Баг #9, #15:** Форматирование через `GetFormattedDaysForItemUseCase` на MainScreen, CreateEditScreen и DetailScreen.
- **Баг #12:** Хранение оригинальных данных (`_originalItem`, `_hasChanges`), `checkHasChanges()` сравнивает поля с оригинальными. Кнопка активна: новые записи `isValidData`, редактирование `isValidData && hasChanges`.
- **Баг #13:** Исправлена логика заголовка: `itemId != null` → `edit_item`, `itemId == null` → `new_item`.
- **Баг #14:** В `formatMonthDay()` добавлена конвертация `totalMonths = period.years * 12 + period.months`.

---

## ❌ Баг #5: Список поиска не учитывает безопасную зону при повороте экрана и поиск закрывается

### Описание

**Проблема 1 (список заезжает под камеру при повороте):**
При открытом режиме поиска, если повернуть экран (из вертикального в горизонтальный или наоборот), список результатов поиска не учитывает безопасную зону и попадает под камеру/челку.

**Проблема 2 (поиск закрывается при повороте):**
Если экран сначала отображается вертикально, пользователь открывает поиск, а затем поворачивает экран, то поиск автоматически закрывается и состояние поиска сбрасывается.

### Причина

1. **Список в SearchBar не учитывает безопасную зону:**
   - При повороте экрана система пересчитывает safe area insets
   - Список результатов поиска внутри SearchBar не применяет эти insets к своей верстке

2. **Состояние поиска не сохраняется при повороте:**
   - State переменная `isSearchActive` не сохраняется при конфигурационных изменениях
   - Отсутствует использование `rememberSaveable`
   - При повороте экрана Activity пересоздается и состояние сбрасывается

### Шаги исправления

1. **Анализ реализации поиска:**
   - Изучить `MainScreen.kt` - компонент SearchBar и его content
   - Проверить передачу состояния `isSearchActive` в SearchBar
   - Проверить рендеринг списка результатов поиска
   - Изучить обработку safe area insets в MainScreen (по аналогии с исправлением бага #8)
   - Проверить наличие `paddingValues` или `WindowInsets` в SearchBar content
   - Проверить хранение состояния `isSearchActive` (remember или rememberSaveable)

2. **Добавление безопасной зоны к списку поиска:**
   - Добавить `WindowInsets.systemBars` к списку результатов
   - Применить через `Modifier.padding(WindowInsets.systemBars.asPaddingValues())`
   - Проверить работу для обеих ориентаций (вертикальной и горизонтальной)

3. **Сохранение состояния поиска при повороте:**
   - Заменить `remember` на `rememberSaveable` для `isSearchActive`
   - Проверить сохранение состояния поиска при повороте экрана

4. **Тестирование:**
   - Повернуть вертикальный экран в горизонтальный с открытым поиском - список должен учитывать безопасную зону, поиск не закрываться
   - Повернуть горизонтальный экран в вертикальный с открытым поиском - список должен учитывать безопасную зону, поиск не закрываться
   - Проверить корректность фильтрации результатов после поворота
   - Убедиться в отсутствии артефактов при верстке в разных ориентациях

---

## Стратегия тестирования

### Перед исправлениями

1. Запустить полный набор тестов для фиксации текущего состояния
2. Создать baseline screenshots для сравнения

### После каждого исправления

1. Проверить, что исправление решает проблему
2. Убедиться, что не появляются новые баги
3. Обновить тесты для покрытия исправлений
4. Обновить скриншоты для документации

### Финальное тестирование

1. Полное регрессионное тестирование всех функций
2. Проверка производительности
3. Проверка UX

---

## Зависимости

Эти исправления затрагивают следующие экраны и компоненты:

- **MainScreen.kt** - основной экран (баги #2, #3, #4, #5, #6, #8, #11, #14)
- **ListItemView.kt** - компонент карточки (баги #6, #11, #14)
- **DetailScreen.kt** - экран деталей (баги #1, #10, #15)
- **CreateEditScreen.kt** - экран создания/редактирования (баги #9, #10, #11, #13, #14)
- **RootScreenComponents.kt** - навигация (баги #2, #7, #11)
- **MainScreenViewModel.kt** - ViewModel (баги #3, #5, #9, #14)
- **CreateEditScreenViewModel.kt** - ViewModel (баг #12)
- **DetailContent.kt** - компонент деталей (баг #15)
- **DaysFormatterImpl.kt** - форматирование (баг #14)
- **CalculateDaysDifferenceUseCase.kt** - вычисление разницы дат (баг #14)
- **FormatDaysTextUseCase.kt** - форматирование текста (баг #14)
- **GetFormattedDaysForItemUseCase.kt** - получение форматированного текста (баг #14)
- **DisplayOption.kt** - модель опции отображения (баг #14)
- **TimePeriod.kt** - модель периода времени (баг #14)

---

## Критерии завершения

План считается выполненным, когда:

- ✅ Все 15 багов исправлен (остался баг #5 - список поиска и поворот экрана)
- ✅ Исправленные изменения протестированы
- ✅ Нет новых багов
- ✅ Производительность не ухудшилась
