# Этап 6: Форматирование количества дней — План реализации

## Обзор

Документ описывает пошаговый план реализации функционала форматирования количества дней для Jetpack Days. Функционал включает вычисление разницы между датами и форматирование результата в соответствии с выбранной опцией отображения.

**Статус:** ✅ РЕАЛИЗОВАН
**Приоритет:** ВЫСОКИЙ (критическая бизнес-функция)

---

## Анализ требований

### Входные данные

1. **Дата события** (timestamp: Long) — дата создания/изменения записи
2. **Текущая дата** — системная дата
3. **Опция отображения** (DisplayOption) — выбранный пользователем формат

### Опции отображения

| Опция | Формат | Примеры |
|-------|--------|---------|
| Day | "X дней" | "5 дней", "365 дней" |
| Month+Day | "X месяцев Y дней" | "2 месяца 5 дней", "11 месяцев 30 дней" |
| Year+Month+Day | "X лет Y месяцев Z дней" | "1 год 2 месяца 5 дней" |

### Специальные случаи

- Разница = 0 дней → "Сегодня" (Today)
- Множественное число с учетом языковых особенностей

### Локализация

- Русский (ru): день/дня/дней, месяц/месяца/месяцев, год/года/лет
- Английский (en): day/days, month/months, year/years
- Ресурсы уже подготовлены в `Localization_Plan.md`

---

## Архитектурное решение

**Примечание:** UI ресурсы рефакторинг выполнен в `UI_Resources_Refactoring_Plan.md`.

---

## Реализованные компоненты ✅

### Domain Layer ✅

Модели (`TimePeriod`, `DaysDifference`), Use Cases (вычисление разницы дат, форматирование текста), тесты.

### Data Layer ✅

`DaysFormatter`, `ResourceProvider` с реализациями, тесты.

### Dependency Injection ✅

`FormatterModule`, `AppModule` — ручной DI.

### Presentation Layer ✅

ViewModels (`DaysCalculatorViewModel`), UI Components (`DaysCountText`, стили), все экраны (`RootScreen`, `MainScreen`, `DetailScreen`, `CreateEditScreen`), тесты.

### UI Ресурсы ✅

`dimens.xml`, `colors.xml`, `NumberFormattingUtils.kt`, локализация (ru + en), все локальные константы удалены.

### Интеграция ✅

`MainScreenViewModel` — использует `Item.makeDaysCount()`, интеграция выполнена во всех экранах.

---

## Этап 10: Тестирование в приложении

### 10.1 Ручное тестирование ❌ НЕ ВЫПОЛНЕНО

**Сценарии тестирования:**

1. **Главный экран:**
   - ❌ Открыть приложение
   - ❌ Проверить отображение дней для всех элементов
   - ❌ Проверить корректность множественного числа
   - ❌ Проверить "Сегодня" для сегодняшнего события

2. **Изменение опции отображения:**
   - ❌ Изменить DisplayOption в настройках
   - ❌ Вернуться на главный экран
   - ❌ Проверить, что формат обновился
   - ❌ Проверить все три опции

3. **Экран деталей:**
   - ❌ Открыть элемент
   - ❌ Проверить отображение дней
   - ❌ Проверить подробную информацию (если есть)

4. **Создание/редактирование:**
   - ❌ Создать новый элемент
   - ❌ Проверить предпросмотр дней
   - ❌ Сохранить и проверить отображение на главном экране

5. **Смена локали:**
   - ❌ Изменить язык на английский
   - ❌ Проверить форматирование на английском
   - ❌ Вернуть русский язык

6. **Краевые случаи:**
   - ❌ Создать элемент с сегодняшней датой
   - ❌ Создать элемент с вчерашней датой
   - ❌ Создать элемент с датой 1 год назад
   - ❌ Создать элемент с датой в високосный год (29 февраля)

---

### 10.2 Автоматизированное тестирование ❌ НЕ ВЫПОЛНЕНО

**UI тесты (Espresso/Compose Testing):**

- ❌ Тест на главном экране
- ❌ Тест на экране деталей
- ❌ Тест на экране настроек (изменение DisplayOption)
- ❌ Тест на смену локали

---

## Этап 11: Оптимизация и улучшения

### 11.1 Производительность ❌ НЕ НАЧАТО

Кэширование, `remember` в Compose, оптимизация для больших списков.

### 11.2 Обработка ошибок ✅ ВЫПОЛНЕНО

Валидация timestamp, обработка некорректных дат, fallback на "Today".

### 11.3 Логирование ✅ ВЫПОЛНЕНО ЧАСТИЧНО

Логи в `CalculateDaysDifferenceUseCase` и `DaysCalculatorViewModel`.

---

## Порядок выполнения

### Выполнено (Фазы 1-4) ✅

Domain + Data слои, DI + ViewModel, UI (компоненты, экраны, навигация, тесты), ресурсы, документация, рефакторинг UI ресурсов.

### Осталось (Фаза 5) ⚠️

- Ручное тестирование на устройстве/симуляторе
- Дополнительные UI тесты (при необходимости)
- Профилирование и оптимизация производительности

**Примечание:** Исправление ошибок линтинга (ktlint, detekt, lint) перенесено в `Stage_6_Refactoring_Plan.md`.

---

## Критерии завершения

**Выполнено:**

- ✅ Unit-тесты (Domain + Data + ViewModel)
- ✅ Compose тесты для DaysCountText
- ✅ UI ресурсы и константы
- ✅ Все экраны (RootScreen, MainScreen, DetailScreen, CreateEditScreen)
- ✅ Локализация (ru + en), три опции отображения, документация

**Осталось:**

- ⚠️ Ручное тестирование по сценариям (требует запуска приложения)
- ⚠️ Совместимость с iOS (требует проверки)

**Примечание:** Критерии прохождения ktlint, detekt и lint перенесены в `Stage_6_Refactoring_Plan.md`.

---

## Примечания

**DI:** Ручной DI через `FormatterModule` и `AppModule` (подробности в `Hilt_Setup_Plan.md`).

**Архитектура:** Clean Architecture, `java.time.LocalDate`, корутины, нет сетевых источников, логи на русском, безопасная обработка опционалов.
