# Этап 6: Форматирование количества дней — План реализации

## Обзор

Документ описывает пошаговый план реализации функционала форматирования количества дней для Jetpack Days. Функционал включает вычисление разницы между датами и форматирование результата в соответствии с выбранной опцией отображения.

**Статус:** ✅ РЕАЛИЗОВАН
**Приоритет:** ВЫСОКИЙ (критическая бизнес-функция)

---

## Анализ требований

### Входные данные

1. **Дата события** (timestamp: Long) — дата создания/изменения записи
2. **Текущая дата** — системная дата
3. **Опция отображения** (DisplayOption) — выбранный пользователем формат

### Опции отображения

| Опция | Формат | Примеры |
|-------|--------|---------|
| Day | "X дней" | "5 дней", "365 дней" |
| Month+Day | "X месяцев Y дней" | "2 месяца 5 дней", "11 месяцев 30 дней" |
| Year+Month+Day | "X лет Y месяцев Z дней" | "1 год 2 месяца 5 дней" |

### Специальные случаи

- Разница = 0 дней → "Сегодня" (Today)
- Множественное число с учетом языковых особенностей

### Локализация

- Русский (ru): день/дня/дней, месяц/месяца/месяцев, год/года/лет
- Английский (en): day/days, month/months, year/years
- Ресурсы уже подготовлены в `Localization_Plan.md`

---

## Архитектурное решение

**Примечание:** Часть работы по рефакторингу UI ресурсов выполнена в отдельном плане: `UI_Resources_Refactoring_Plan.md`.

---

## Реализованные компоненты ✅

### Domain Layer ✅

**Модели:**
- `TimePeriod` — DTO для периода (годы/месяцы/дни)
- `DaysDifference` — sealed класс для результата вычислений (`Today`, `Calculated`)
- `ItemExtensions` — расширение `Item.makeDaysCount()`

**Use Cases:**
- `CalculateDaysDifferenceUseCase` — вычисление разницы дат
- `FormatDaysTextUseCase` — форматирование текста
- `GetFormattedDaysForItemUseCase` — use case для Item

**Тесты:** ✅ Все unit-тесты созданы

---

### Data Layer ✅

**Интерфейсы и реализации:**
- `DaysFormatter` + `DaysFormatterImpl` — форматирование текста
- `ResourceProvider` + `ResourceProviderImpl` — доступ к ресурсам

**Тесты:** ✅ Все unit-тесты созданы

---

### Dependency Injection ✅

- `FormatterModule` — ручной DI для форматирования
- `AppModule` — DI для приложения
- Hilt временно отключен (подробности в `Hilt_Setup_Plan.md`)

---

### Presentation Layer ✅

**ViewModels:**
- `DaysCalculatorViewModel` — состояние UI, тесты ✅

**UI Components:**
- `DaysCountText` — Compose компонент для отображения
- `DaysCountTextStyle` — стили отображения (NORMAL/EMPHASIZED/SECONDARY)

**Экраны:**
- `ListItemView` — элемент списка
- `DetailScreen` + `DetailScreenViewModel` — экран деталей
- `CreateEditScreen` + `CreateEditScreenViewModel` — создание/редактирование
- `RootScreen` + `RootScreenViewModel` — навигация и роутинг
- `MainScreen` + `MainScreenViewModel` — главный экран

**Тесты:** ✅ Unit-тесты для ViewModel, Compose тесты для DaysCountText

---

### UI Ресурсы и константы ✅ (выполнено в UI_Resources_Refactoring_Plan)

**Размеры (dimens.xml):**
- Spacings: 4, 8, 12, 16, 24, 32 dp
- Sizes: 32, 48, 80 dp
- Icon sizes: 32, 48, 80 dp
- Color tag sizes: 48, 12 dp

**Цвета (colors.xml):**
- Material colors (purple, teal, black, white)
- Tag colors (red, teal, blue, green, yellow, purple)

**Утилиты:**
- `NumberFormattingUtils.kt` — форматирование множественного числа для русского языка

**Константы:**
- ✅ Все локальные объекты констант удалены
- ✅ Все размеры берутся из `R.dimen.*`
- ✅ Все цвета берутся из `R.color.*`
- ✅ Все форматирования чисел берутся из `NumberFormattingUtils`

**Локализация:**
- Локализованные строки (ru + en)
- Строковые ресурсы для форматирования дней, месяцев, лет

**Навигация:** маршруты для всех экранов  
**Документация:** KDoc, обновленный план

---

## Оставшиеся задачи

### 6.3 Интегрировать в MainScreenViewModel ✅ ВЫПОЛНЕНО

**Файл:** `app/src/main/java/com/dayscounter/viewmodel/MainScreenViewModel.kt`

**Статус:** ✅ ВЫПОЛНЕНО

**Реализация:** ViewModel создана и протестирована, использует `Item.makeDaysCount()` для форматирования.

**Примечание:** Все UI компоненты готовы к использованию, интеграция выполнена в экранах.

---

## Этап 10: Тестирование в приложении

### 10.1 Ручное тестирование ❌ НЕ ВЫПОЛНЕНО

**Сценарии тестирования:**

1. **Главный экран:**
   - ❌ Открыть приложение
   - ❌ Проверить отображение дней для всех элементов
   - ❌ Проверить корректность множественного числа
   - ❌ Проверить "Сегодня" для сегодняшнего события

2. **Изменение опции отображения:**
   - ❌ Изменить DisplayOption в настройках
   - ❌ Вернуться на главный экран
   - ❌ Проверить, что формат обновился
   - ❌ Проверить все три опции

3. **Экран деталей:**
   - ❌ Открыть элемент
   - ❌ Проверить отображение дней
   - ❌ Проверить подробную информацию (если есть)

4. **Создание/редактирование:**
   - ❌ Создать новый элемент
   - ❌ Проверить предпросмотр дней
   - ❌ Сохранить и проверить отображение на главном экране

5. **Смена локали:**
   - ❌ Изменить язык на английский
   - ❌ Проверить форматирование на английском
   - ❌ Вернуть русский язык

6. **Краевые случаи:**
   - ❌ Создать элемент с сегодняшней датой
   - ❌ Создать элемент с вчерашней датой
   - ❌ Создать элемент с датой 1 год назад
   - ❌ Создать элемент с датой в високосный год (29 февраля)

---

### 10.2 Автоматизированное тестирование ❌ НЕ ВЫПОЛНЕНО

**UI тесты (Espresso/Compose Testing):**
- ❌ Тест на главном экране
- ❌ Тест на экране деталей
- ❌ Тест на экране настроек (изменение DisplayOption)
- ❌ Тест на смену локали

---

## Этап 11: Оптимизация и улучшения

### 11.1 Производительность ❌ НЕ НАЧАТО

**Оптимизировать:**
- ❌ Кэширование форматированного текста (если часто вызывается)
- ❌ Использование `remember` в Compose для предотвращения лишних рекомпозиций
- ❌ Оптимизация вычислений для больших списков

### 11.2 Обработка ошибок ✅ ВЫПОЛНЕНО

Валидация timestamp, обработка некорректных дат, fallback на "Today".

### 11.3 Логирование ✅ ВЫПОЛНЕНО ЧАСТИЧНО

Логи в `CalculateDaysDifferenceUseCase` и `DaysCalculatorViewModel`.

---

## Порядок выполнения

### Выполнено (Фазы 1-4) ✅
1-5. Domain + Data слои (модели, use cases, formatter)  
6-9. DI + ViewModel (ручной DI, ViewModels, тесты)  
10-16. UI (компоненты, экраны, навигация, тесты)  
17-19. Ресурсы, документация, код-ревью  
20. UI Рефакторинг ресурсов — созданы dimens.xml, colors.xml, NumberFormattingUtils.kt, удалены локальные константы

### Осталось (Фаза 5) ⚠️
- Ручное тестирование на устройстве/симуляторе
- Дополнительные UI тесты (при необходимости)
- Профилирование и оптимизация производительности

**Примечание:** Исправление ошибок линтинга (ktlint, detekt, lint) перенесено в `Stage_6_Refactoring_Plan.md`.

---

## Критерии завершения

- ✅ Unit-тесты бизнес-логики (Domain + Data)
- ✅ Unit-тесты ViewModel
- ✅ Compose тесты для DaysCountText
- ✅ UI ресурсы и константы (dimens.xml, colors.xml, NumberFormattingUtils.kt)
- ✅ Все локальные константные объекты удалены
- ✅ RootScreen, MainScreen, DetailScreen, CreateEditScreen созданы и протестированы
- ✅ MainScreenViewModel создана и протестирована
- ⚠️ Ручное тестирование по сценариям (требует запуска приложения)

**Примечание:** Критерии прохождения ktlint, detekt и lint перенесены в `Stage_6_Refactoring_Plan.md`.
- ✅ Локализация (ru + en)
- ✅ Три опции отображения
- ✅ Документация обновлена
- ⚠️ Совместимость с iOS (требует проверки)

---

## Примечания

**DI:** Ручной DI через `FormatterModule` и `AppModule` (подробности в `Hilt_Setup_Plan.md`).

**Архитектура:** Clean Architecture, `java.time.LocalDate`, корутины, нет сетевых источников, логи на русском, безопасная обработка опционалов.
