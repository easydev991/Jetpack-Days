---
alwaysApply: true
---

# Архитектура

## MVVM

- **Model**: Data layer (Room, repositories)
- **View**: Compose UI
- **ViewModel**: UI state management

## Clean Architecture

```
Presentation (UI, ViewModel)
├── Domain (Use Cases, entities)
└── Data (Repositories, только локальные источники)
```

**Важно:** Нет сетевых источников данных.

---

## Dependency Injection (DI)

**Ручной DI через factory методы** в `FormatterModule` и `AppModule`. Проект не использует Hilt.

**Причины:** простой граф зависимостей, быстрая компиляция, меньше зависимостей, простые тесты.

**DI модули:**

- `FormatterModule` - factory методы для форматирования и use cases
- `AppModule` - factory методы для репозитория и DataStore

**Примечание:** Hilt стоит рассмотреть при росте проекта (>10 ViewModel, сложные графы зависимостей). См. `docs/Hilt_Setup_Plan.md`

## Слои

### Data

- **Room**: `ItemEntity`, `ItemDao`, `DaysDatabase`, конвертеры
- **Repository**: `ItemRepositoryImpl` - реализация репозитория
- **Formatter**: `DaysFormatter`, `ResourceProvider` - локализация
- **Preferences**: `AppSettingsDataStore` - хранение настроек (тема, иконка, сортировка)

### Domain

- **Use Cases**: бизнес-логика, один use case - одна ответственность:
  - `CalculateDaysDifferenceUseCase`, `FormatDaysTextUseCase`, `GetFormattedDaysForItemUseCase`
  - `GetDaysAnalysisTextUseCase`, `ExportBackupUseCase`, `ImportBackupUseCase`
  - `IconManager` - смена иконки приложения
- **Entities**: `Item`, `DaysDifference`, `DisplayOption`, `SortOrder`, `AppTheme`, `AppIcon`, `TimePeriod`
- **Repository Interface**: `ItemRepository` - абстракция репозитория

### Presentation

- **ViewModels**: `MainScreenViewModel`, `CreateEditScreenViewModel`, `DetailScreenViewModel`, `RootScreenViewModel`, `AppDataScreenViewModel`, `ThemeIconViewModel`, `MainActivityViewModel`
- **UI State**: sealed классы (Loading/Success/Error), `AppDataUiState`, `RootScreenState`, `ThemeIconUiState`
- **Screens**: Compose экраны в `ui/screen/`
- **Navigation**: `navigation/Screen.kt`
- **Theme**: тема в `ui/theme/`

### Utilities

- **Logger**: `Logger` интерфейс (`AndroidLogger`, `NoOpLogger`)
- **Analytics**: `FirebaseAnalyticsHelper` - screen_view, события (только release)
- **Crash**: `CrashlyticsHelper` - отчеты о крашах (только release)
